
---
title: "Loop Simulations"
author: "Lizzy Gibson"
date: "3/5/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)

library(MASS)
library(tidyverse)
library(GGally)
```

## 1: Distinct Patterns

### Simulate Patterns

* Generate 4 non-negative vectors of length 50
* Pattern matrix is 4*50, patterns by chemicals
* Draw each pattern: number 1-2 if pattern is ON, basically 0 otherwise

```{r}
rand_vec = as.integer(rand_num(100) * ((2^31)-1))

## Construct a matrix for 4 TRUE exposure patterns
## replace runif between 0--0.2 with rep 0
create_patterns_dist <- function (seed) {
  set.seed(seed)
  patterns_dist <- 
    rbind(c(rep(1,12), rep(0,38)),
          c(rep(0,12), rep(1,12), rep(0,26)),
          c(rep(0,24), rep(1,13), rep(0,13)),
          c(rep(0,37), rep(1,13)))
  patterns_dist
}

patterns_dist_iter <- tibble(seed = rand_vec) %>% 
 mutate(true_patterns = map(seed, create_patterns_dist))
```

### Simulate Scores

* Generate non-negative scores
* 1,000 individuals with scores on each of 4 patterns
   
```{r}
create_scores_dist <- function (seed) {
  set.seed(seed)
  scores <- matrix(exp(rnorm(1000*4)), ncol = 4)

  return(as.matrix(scores))
}

scores_dist_iter <- patterns_dist_iter %>% 
 mutate(true_scores = map(seed, create_scores_dist))
```

### Simulate Chemical Exposures

* Matrix multiple scores and pattern loadings

```{r}
sim_dist <- scores_dist_iter %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))
```

### Simulate Noise

* Add noise
* Noise distribution Normal(0, s)
    * where s = simulated variance/10 for each variable
    
```{r}
add_noise <- function (seed, chemx) {
  n = nrow(chemx)
  p = ncol(chemx)
  noise <- matrix(rnorm(n*p, mean = 0, sd = 1), nrow = n, ncol = p)
  sim = pmax(chemx + noise, 0)
  return(sim)
}

sim_dist <- sim_dist %>% 
 mutate(sim = map2(seed, chem, add_noise))
```  

```{r}
dist<- sim_dist$sim[[1]]
ggcorr(dist)
```

## 2: Overlapping Patterns

### Simulate Patterns

* Generate 4 non-negative vectors of length 50
* Pattern matrix is 4*50, patterns by chemicals
* Draw each pattern: number 1-2 if pattern is ON, 0.5-1 is the overlapping group, basically 0 otherwise
```{r}
create_patterns_over <- function (seed) {
  set.seed(seed)
  pat1=c(0,0,5,10)
  pat2=c(0,5,10,0)
  pat3=c(5,10,0,0)
  pat4=c(10,0,0,5)

  patterns = cbind(t(rdirichlet(13, pat1)), t(rdirichlet(13, pat2)),
                   t(rdirichlet(12, pat3)), t(rdirichlet(12, pat4)))
  return(as.matrix(patterns))
}

patterns_over_iter <- tibble(seed = rand_vec) %>% 
 mutate(true_patterns = map(seed, create_patterns_over))
```

### Simulate Chemical Exposures

* Matrix multiple scores and pattern loadings

```{r}
sim_over <- scores_dist_iter %>% 
  dplyr::select(seed, true_scores) %>% 
  full_join(., patterns_over_iter) %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))
```

### Simulate Noise

* Add noise
* Noise distribution Normal(0, s)
    * where s = simulated variance/4 for each variable
    
```{r}
sim_over <- sim_over %>% 
 mutate(sim = map2(seed, chem, add_noise))
```  

```{r}
over <- sim_over$sim[[1]]
ggcorr(over)
```

## 3. Correlated Scores

### Simulate Scores

```{r}
create_scores_cor <- function (seed) {
  scores_cor <- matrix(nrow = 1000, ncol = 4)
  cov <- matrix( c(1,    0.25, 0.15, 0.15,
                  0.25, 1,    0.15, 0.15,
                  0.15, 0.15, 1,    0.25,
                  0.15, 0.15, 0.25, 1), nrow = 4)
  
  set.seed(seed)
  scores_cor <- exp(mvrnorm(n = 1000, mu = rep(0, 4), 
                          Sigma = cov)) # dists are kind of DEPENDENT
  }

scores_cor_iter <- patterns_over_iter %>% 
 mutate(true_scores = map(seed, create_scores_cor))
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture. Use simulated overlapping patterns.

```{r}
sim_cor <- scores_cor_iter %>% 
  dplyr::select(seed, true_scores) %>% 
  full_join(., patterns_over_iter) %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))
```

### Simulate Noise

```{r}
sim_cor <- sim_cor %>% 
 mutate(sim = map2(seed, chem, add_noise))
```  

```{r}
simm <- sim_cor$sim[[1]]
ggcorr(simm)
```

## Save

```{r} 
sim_dgp <- rbind(sim_dist %>% mutate(data = "Distinct"),
      sim_over %>% mutate(data = "Overlapping"),
      sim_cor %>% mutate(data = "Correlated"))
  
sim_dgp

# for (i in 1:nrow(sim_dgp)) {
#   write_csv(as_tibble(sim_dgp$sim[[i]]),           paste0("./Sims/Main/sim_dgp_", i, ".csv"))
#   write_csv(as_tibble(sim_dgp$chem[[i]]),          paste0("./Sims/Main/chem_dgp_", i, ".csv"))
#   write_csv(as_tibble(sim_dgp$true_patterns[[i]]), paste0("./Sims/Main/patterns_dgp_", i, ".csv"))
#   write_csv(as_tibble(sim_dgp$true_scores[[i]]),   paste0("./Sims/Main/scores_dgp_", i, ".csv"))
# }

# save(sim_dgp, file = "./Sims/Main/sim_dgp.RDA")



```


