---
title: "Test NMF on Sims"
author: "Lizzy Gibson"
date: "7/24/2019"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(reshape2) # melt
library(gridExtra) # gridarrange
library(tidyverse)
library(R.matlab)
library(NMF)
```

## Read in Sims

```{r}
sim1 <- read_csv("./Sims/sim_data_1.csv")
sim2 <- read_csv("./Sims/sim_data_2.csv")
sim3 <- read_csv("./Sims/sim_data_3.csv")
```

## NMF Function

```{r}
# % NMF implements non-negative matrix factorization of the matrix X
# % according to a predefined penalty.

# % X : D x N matrix of nonnegative numbers
# % K : rank of factorization, takes value in {1,2,3,...,min(D,N)}
# % penalty : string taking one of two values, 'L2' or 'divergence'
# % num_iter : number of iterations

nmf_ee <- function(X, K, penalty, num_iter) {

  X <- as.matrix(X)
  D <- nrow(X)
  N <- ncol(X)
  
  # Initiate W and H matrices with random non-zero values
  W <- matrix(1, nrow = D, ncol = K) + matrix(runif(D*K), nrow = D, ncol = K)
  H <- matrix(1, nrow = K, ncol = N) + matrix(runif(K*N), nrow = K, ncol = N)
  
  temp <- sum(X)/sum(W %*% H) 
  # temp is the magnitude of the original matrix divided by the matrix product of W and H
  # each iteration, this ratio should get closer to 1
  W <- W*sqrt(temp) 
  # new W is scaled by the magnitude of the ratio between the original X and the current W and H
  # each iteration, this W gets closer to the solution
  H <- H*sqrt(temp) 
  # new H is scaled by the magnitude of the ratio between the original X and the current W and H
  # each iteration, this H gets closer to the solution
  
  L <- matrix() # empty to fill in with loss function
  
  # Define 'eps'
  # 'eps' is the distance from 1.0 to the next larger double-precision floating point number, that is, 2-52.
  eps <- 2.2204e-16
  
  if (!(penalty %in% c('L2', 'divergence'))) {print('Invalid penalty input.')}
  
  # Iterate to minimize loss function
    else if (penalty == 'L2') {
      for (i in 1:num_iter) {
            H <- H * (t(W) %*% X) / ((t(W) %*% W) %*% H + eps) # eps prevents division by zero
            W <- W * (X %*% t(H)) / (W %*% (H %*% t(H)) + eps)
      # Loss function -- Gaussian MLE
      L[i] <- sum((X - W %*% H)^2)
      }
      return(list(ind_scores = W, chem_loadings = H, loss = L))
      }
  
    else if (penalty == 'divergence') {
      for (i in 1:num_iter) {
          H <- H * (t(W / kronecker(matrix(1,D,1), matrix(colSums(W), nrow=1))) %*% (X / (W %*% H + eps)))
          # kronecker creates a matrix of the column sums of W repeated row-stacked
          W <- W * ((X / (W %*% H + eps)) %*% t(H / kronecker(matrix(1,1,N), matrix(rowSums(H), ncol = 1))))
          # kronecker creates a matrix of the row sums of H repeated column-stacked
      # Loss function -- Poisson MLE
      L[i] <- (-sum(X * log(W %*% H))) + (sum(W %*% H))
      }
      return(list(ind_scores = W, chem_loadings = H, loss = L))
      }
  }
```

## Compare Results

### 10x10

```{r}
#fake <- matrix(1:100, nrow = 10, byrow = TRUE)
#fake

#nmf_ee(fake, 4, "L2", 100)
# L2 results same when ones replace rand

#nmf_ee(fake, 4, "divergence", 100)
# divergence results same when ones replace rand
```

## L2 Penalty

### Distinct Patterns

```{r}
results_dist_l2 <- nmf_ee(sim1, 4, "L2", 10000)
```

```{r}
r_dist_l2 <- results_dist_l2$chem_loadings %>% as_tibble()

r_dist_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Distinct Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_dist_l2 <- readMat("./Sims/results_dist_H_l2.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_dist_l2) <- names(r_dist_l2)

matlab_dist_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank())+
  labs(title = "Patterns for Distinct Groups -- MATLAB")

round(r_dist_l2 - matlab_dist_l2, 4)
```

#### Compare NMF Function

```{r}
results_dim_l2_builtin <- nmf(sim1, 4, method = "lee")

coef(results_dim_l2_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Distinct Groups -- Built-in R function")
```

### Overlapping Patterns

```{r}
results_over_l2 <- nmf_ee(sim2, 4, "L2", 10000)
```

```{r}
r_over_l2 <- results_over_l2$chem_loadings %>% as_tibble()

r_over_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_over_l2 <- readMat("./Sims/results_over_H_l2.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_over_l2) <- names(r_over_l2)

matlab_over_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- MATLAB")

round(matlab_over_l2 - r_over_l2, 4)
```

#### Compare NMF Function

```{r}
results_over_l2_builtin <- nmf(sim2, 4, method = "lee")

coef(results_over_l2_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- Built-in R function")
```

### Correlated Patterns

```{r}
results_corr_l2 <- nmf_ee(sim3, 4, "L2", 10000)
```

```{r}
r_corr_l2 <- results_corr_l2$chem_loadings %>% as_tibble() 

r_corr_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_corr_l2 <- readMat("./Sims/results_corr_H_l2.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_corr_l2) <- names(r_corr_l2)

matlab_corr_l2 %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- MATLAB")

round(matlab_corr_l2 - r_corr_l2, 4)
```

#### Compare NMF Function

```{r}
results_corr_l2_builtin <- nmf(sim3, 4, method = "lee")

coef(results_corr_l2_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- Built-in R function")
```

## Poisson Penalty

### Distinct Patterns

```{r}
results_dist_p <- nmf_ee(sim1, 4, "divergence", 10000)
```

```{r}
r_dist_p <- results_dist_p$chem_loadings %>% as_tibble() 

r_dist_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Distinct Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_dist_p <- readMat("./Sims/results_dist_H_p.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_dist_p) <- names(r_dist_p)

matlab_dist_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Distinct Groups -- MATLAB")

round(r_dist_p - matlab_dist_p, 4)
```

#### Compare NMF Function

```{r}
results_dim_p_builtin <- nmf(sim1, 4, method = "brunet")

coef(results_dim_p_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Distinct Groups -- Built-in R function")
```

### Overlapping Patterns

```{r}
results_over2 <- nmf_ee(sim2, 4, "divergence", 10000)
```

```{r}
r_over_p <- results_over2$chem_loadings %>% as_tibble()
  
r_over_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_over_p <- readMat("./Sims/results_over_H_p.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_over_p) <- names(r_over_p)

matlab_over_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- MATLAB")

round(matlab_over_p - r_over_p, 4)
```

#### Compare NMF Function

```{r}
results_over_p_builtin <- nmf(sim2, 4, method = "brunet")

coef(results_over_p_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Overlapping Groups -- Built-in R function")
```

### Correlated Patterns

```{r}
results_corr_p <- nmf_ee(sim3, 4, "divergence", 10000)
```

```{r} 
r_corr_p <- results_corr_p$chem_loadings %>% as_tibble() 

r_corr_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- R")
```

#### Compare MATLAB

```{r}
matlab_corr_p <- readMat("./Sims/results_corr_H_p.mat") %>% 
  as.data.frame() %>% as_tibble()

names(matlab_corr_p) <- names(r_corr_p)

matlab_corr_p %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- MATLAB")

round(matlab_corr_p - r_corr_p, 4)
```

#### Compare NMF Function

```{r}
results_corr_p_builtin <- nmf(sim3, 4, method = "brunet")

coef(results_corr_p_builtin) %>% 
  as_tibble() %>% 
  mutate(Pattern = 1:4) %>% select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Group = case_when(grepl("pcb", Chemicals) ~ "PCBs",
                           grepl("BDE", Chemicals) ~ "PBDEs",
                           grepl("^M", Chemicals) ~ "PHTs",
                           grepl("p_|_p", Chemicals) ~ "Phenols",
                           Chemicals == "tcs" ~ "Phenols",
                           Chemicals == "bpa" ~ "Phenols")) %>% 
  arrange(Group) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom",
        strip.background = element_blank()) +
  labs(title = "Patterns for Correlated Groups -- Built-in R function")
```