---
title: "NMF & Sim Data -- Iterate"
author: "Lizzy Gibson"
date: "2/27/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
```

## Load Sims

```{r}
load(here::here("./Sims/Iterate/sim_dist.RDA"))
sim_dist

load(here::here("./Sims/Iterate/sim_cor.RDA"))
sim_cor

load(here::here("./Sims/Iterate/sim_over.RDA"))
sim_over
```

## NMF

### Distinct Patterns

```{r}
get_coef <- function (sim) {
  as_tibble(coef(nmf(sim, rank = 4)))
}

get_pred <- function (sim) {
  basis(nmf(sim, rank = 4)) %*% coef(nmf(sim, rank = 4))
}

nmf_out_dist <- sim_dist %>% filter(seed == 5) %>% 
  mutate(coef = map(sim, ~get_coef(.x)),
         pred = map(sim, ~get_pred(.x)))

nmf_coef_dist <- nmf_out_dist %>% select(seed, coef) %>% unnest(cols = c(coef))
```

#### Norms

```{r}
#All
nmf_out_dist %>%
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

#Coefs
nmf_coef_dist %>%
  mutate(pattern1 = as.factor(ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5)))))) %>%
  select(seed, pattern1, everything()) %>% arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(pattern1)) %>% 
  select(-pattern1) %>% 
  nest(reorder_coef = pcb28:bpa) %>% 
  left_join(., nmf_out_dist, by = "seed") %>% 
  select(seed, patterns, reorder_coef) %>% 
  mutate(norm_coefs = map2(patterns, reorder_coef, ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coefs) %>% 
  pull(norm_coefs) %>% summary()
```

#### Viz

```{r}
nmf_coef_dist %>%  
  filter(seed == 3) %>%
  mutate(pattern = 1:4) %>% 
  select(seed, pattern, everything()) %>% 
    mutate(pattern1 = ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern,-pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

nmf_coef_dist %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
nmf_coef_dist %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

### Overlapping Patterns

```{r}
nmf_out_over <- sim_over %>% 
  mutate(coef = map(sim, ~get_coef(.x)),
         pred = map(sim, ~get_pred(.x)))

nmf_coef_over <- nmf_out_over %>% select(seed, coef) %>% unnest(cols = c(coef))
```

#### Norm

```{r}
#All
nmf_out_over %>%
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

#Coefs
nmf_coef_over %>%
  mutate(pattern1 = as.factor(ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5)))))) %>%
  select(seed, pattern1, everything()) %>% arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(pattern1)) %>% 
  select(-pattern1) %>% 
  nest(reorder_coef = pcb28:bpa) %>% 
  left_join(., nmf_out_dist, by = "seed") %>% 
  select(seed, patterns, reorder_coef) %>% 
  mutate(norm_coefs = map2(patterns, reorder_coef, ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coefs) %>% 
  pull(norm_coefs) %>% summary()
```

#### Viz

```{r}
nmf_coef_over %>%  
  filter(seed == 3) %>%
  mutate(pattern = 1:4) %>% 
  select(seed, pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

nmf_coef_over %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.02 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
nmf_coef_over %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.02 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

### Correlated Scores

```{r}
nmf_out_cor <- sim_cor %>% 
  mutate(coef = map(sim, ~get_coef(.x)),
         pred = map(sim, ~get_pred(.x)))

nmf_coef_cor <- nmf_out_cor %>% select(seed, coef) %>% unnest(cols = c(coef))
```

#### Norm

```{r}
# All
nmf_out_cor %>%
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

# Coefs
nmf_coef_cor %>%
  mutate(pattern1 = as.factor(ifelse(pcb146 > 0.01 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5)))))) %>%
  select(seed, pattern1, everything()) %>% arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(pattern1)) %>% 
  select(-pattern1) %>% 
  nest(reorder_coef = pcb28:bpa) %>% 
  left_join(., nmf_out_dist, by = "seed") %>% 
  select(seed, patterns, reorder_coef) %>% 
  mutate(norm_coefs = map2(patterns, reorder_coef, ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coefs) %>% 
  pull(norm_coefs) %>% summary()
```

#### Viz

```{r}
nmf_coef_cor %>%  
  filter(seed == 3) %>%
  mutate(pattern = 1:4) %>% 
  select(seed, pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

nmf_coef_cor %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.02 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
nmf_coef_cor %>%  
  mutate(pattern = rep(1:4, 100)) %>% 
  select(seed, pattern, everything()) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.02 & pcb118 > bpa, 1,
                          ifelse(BDE17 > 0.02, 2,
                                ifelse(MECPP > 0.02, 3,
                                       ifelse(tcs > 0.02, 4, 5))))) %>%
  gather(key = Chemicals, value = Loadings, -pattern, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank()) + labs(y = "Median Loadings")
```

## Standardize

```{r}
apply(apply(sim_over$sim[[1]], 2, function(x) x/sd(x)), 2, sd)

standardize <- function (any_matrix) {
  apply(any_matrix, 2, function(x) x/sd(x))
  }
  
dist_norm <- nmf_out_dist %>% 
  mutate(sd_patterns = map(patterns, ~standardize(.x)),
         sd_coef = map(coef, ~standardize(.x))) %>% 
  mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef) %>% summary()

over_norm <- nmf_out_over %>% 
  mutate(sd_patterns = map(patterns, ~standardize(.x)),
         sd_coef = map(coef, ~standardize(.x))) %>% 
  mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef) %>% summary()
  
cor_norm <- nmf_out_cor %>% 
  mutate(sd_patterns = map(patterns, ~standardize(.x)),
         sd_coef = map(coef, ~standardize(.x))) %>% 
  mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

summary(over_norm)
summary(cor_norm)
summary(dist_norm)
(sum(cor_norm) + sum(dist_norm) + sum(over_norm)) / 300
```


