---
title: "VCI & Bootstraps"
author: "Lizzy Gibson"
date: "2/13/2021"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
---

```{r setup, include=FALSE}
options(scipen = 999)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

library(tidyverse)
library(GGally)
library(patchwork)
library(R.matlab)

source(here::here("./Results/compare_functions.R"))
source(here::here("./Results/fig_set.R"))
```

## Variational Confidence Intervals

### Steps

Steps to assess coverage:

1. BN$^2$MF outputs:
    a. expected values (means) for W, a, H
    b. $\alpha$ and $\beta$ parameters for W, a, H Gamma distributions
2. Factor correspondence
    a. Match EH with simulated pattern matrix (truth)
    b. Use permutation matrix to rearrange all solution matrices
3. Create variational distributions
    a. Take 1,000 draws each from Gamma distributions for W, a, H
    b. Create scores as $W_{i,k} \times a_k$
4. Normalize \& scale
    a. $\ell^1$ normalize patterns of H
    b. Scale $Wa$ by normalizing constant of corresponding H patterns
5. Create VCI
    a. Take $2.5^{th}$ and $97.5^{th}$ quantiles of scaled Wa distribution
    b. VCI = ($2.5^{th}$, $97.5^{th}$)
6. Asses coverage
    a. $\ell^1$ normalize true patterns
    b. Scale true scores accordingly
    c. Does (i, k) in true scores fall within VCI?
        i. Yes = 1
        ii. No = 0
7. Coverage = proportion of true scores within VCI
    a. sum(yes)/total
    
### Coverage

```{r, load, cache=T, cache.lazy=F}
load("./Bootstrap/bs_vci_metrics.RDA")
```

```{r}
bs_vci_metrics %>% 
  filter(method == "vci" & side == "wa") %>% 
  group_by(data) %>% 
  unnest(prop) %>% 
  summarise(qs = quantile(prop, c(0.25, 0.5, 0.75)), prob = c(0.25, 0.5, 0.75),
            Mean = mean(prop),
            Max = max(prop),
            Min = min(prop)) %>% 
  pivot_wider(names_from = "prob",
              values_from = "qs") %>% 
  ungroup() %>% 
  dplyr::select(Simulations = data, Min, `0.25`, `0.5`, Mean, `0.75`, Max) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  slice(2,3,1) %>% 
  knitr::kable(caption = "Variational coverage for BN2MF scores with annealing and t0 = 0")
```

## Bootstraps

### Steps

Steps to assess coverage:  
  
For each simulated data set:   

1. Repeat steps 150 times,
    a. Take random sample with replacement
    b. Run BN$^2$MF on bootstrapped sample
    c. Factor correspondence
        i. Match EH with simulated pattern matrix (truth)
        ii. Use permutation matrix to rearrange EH and $E[Wa]$
    d. Normalize \& scale
        i. $\ell^1$ normalize patterns of EH
        ii. Scale $E[Wa]$ by normalizing constant of corresponding H patterns
2. Combine bootstraps by row, column indices
3. Create BCI
    a. Take $2.5^{th}$ and $97.5^{th}$ quantiles of bootstrapped scaled $Wa$ distribution
    b. BCI = ($2.5^{th}$, $97.5^{th}$)
4. Asses coverage
    a. $\ell^1$ normalize true patterns
    b. Scale true scores accordingly
    c. Does (i, k) in true scores fall within BCI?
        i. Yes = 1
        ii. No = 0
5. Coverage = proportion of true scores within BCI
    a. sum(yes)/total
  
### Coverage

```{r}
bs_vci_metrics %>% 
  filter(method == "bs" & side == "wa") %>% 
  group_by(data) %>% 
  unnest(prop) %>% 
  summarise(qs = quantile(prop, c(0.25, 0.5, 0.75)), prob = c(0.25, 0.5, 0.75),
            Mean = mean(prop),
            Max = max(prop),
            Min = min(prop)) %>% 
  pivot_wider(names_from = "prob",
              values_from = "qs") %>% 
  ungroup() %>% 
  dplyr::select(Simulations = data, Min, `0.25`, `0.5`, Mean, `0.75`, Max) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  slice(2,3,1) %>% 
  knitr::kable(caption = "Bootstrap coverage for BN2MF scores with annealing and t0 = 0")
```

### Viz

```{r, load-viz, cach=T}
load("./Bootstrap/plot_wa.RDA")
load("./Bootstrap/plot_h.RDA")
load("./Bootstrap/plot_pred.RDA")
```

```{r}
wa_look = plot_wa %>% 
  mutate(sim_type = fct_inorder(sim_type)) %>% 
  ggplot(aes(x = Distribution)) +
  geom_rect(aes(xmin = v_wa_25,  xmax = v_wa_75,  ymin=-Inf, ymax=Inf), 
            color="blue", linetype="dotted", alpha = 0) +
  geom_rect(aes(xmin = bs_wa_25, xmax = bs_wa_75, ymin=-Inf, ymax=Inf), 
            color="red", linetype="dotted", alpha = 0) +
  geom_histogram(aes(y= after_stat(density),fill = Type), 
                 position = "identity", bins = 100, alpha = 0.5) +
  geom_density(aes(group = Type)) +
  scale_fill_manual(values = c("red", "blue")) +
  theme_bw() + 
  geom_vline(aes(xintercept = truth),  linetype="dashed", color = "black") +
  geom_vline(aes(xintercept = bs_ewa), linetype="dashed", color = "red") + 
  geom_vline(aes(xintercept = v_ewa),  linetype="dashed", color = "blue") + 
  facet_grid(sim_type~., scales = "free") +
  theme(legend.position = "bottom",
        strip.background = element_rect(fill="white")) +
  ylab("Density") + ggtitle("Distributions on Scores (Wa)") + xlim(c(0,20))

h_look = plot_h %>% 
  mutate(sim_type = fct_inorder(sim_type)) %>% 
  ggplot(aes(x = Distribution)) +
  geom_rect(aes(xmin = v_h_25,  xmax = v_h_75,  ymin=-Inf, ymax=Inf), 
            color="blue", linetype="dotted", alpha = 0) +
  geom_rect(aes(xmin = bs_h_25, xmax = bs_h_75, ymin=-Inf, ymax=Inf), 
            color="red", linetype="dotted", alpha = 0) +
  geom_histogram(aes(y=after_stat(density),fill = Type), 
                 position = "identity", bins = 100, alpha = 0.5) +
  geom_density(aes(group = Type)) +
  scale_fill_manual(values = c("red", "blue")) +
  theme_bw() + 
  facet_grid(sim_type~., scales = "free") +
  geom_vline(aes(xintercept = truth),  linetype="dashed", color = "black") +
  geom_vline(aes(xintercept = bs_eh), linetype="dashed", color = "red") + 
  geom_vline(aes(xintercept = v_eh),  linetype="dashed", color = "blue") + 
  theme(legend.position = "bottom",
        strip.background = element_rect(fill="white")) +
  ylab("Density") + ggtitle("Distributions on Loadings (H)") + xlim(c(0,0.066))

pred_look = 
  plot_pred %>% 
  mutate(sim_type = fct_inorder(sim_type)) %>% 
  ggplot(aes(x = Distribution)) +
  geom_rect(aes(xmin = v_pred_25,  xmax = v_pred_75,  ymin=-Inf, ymax=Inf), 
            color="blue", linetype="dotted", alpha = 0) +
  geom_rect(aes(xmin = bs_pred_25, xmax = bs_pred_75, ymin=-Inf, ymax=Inf), 
            color="red", linetype="dotted", alpha = 0) +
  geom_histogram(aes(y = after_stat(density), fill = Type), 
                 position = "identity", bins = 100, alpha = 0.5) +
  geom_density(aes(group = Type)) +
  scale_fill_manual(values = c("red", "blue")) +
  theme_bw() + 
  geom_vline(aes(xintercept = truth),  linetype="dashed", color = "black") +
  geom_vline(aes(xintercept = bs_pred), linetype="dashed", color = "red") + 
  geom_vline(aes(xintercept = v_pred),  linetype="dashed", color = "blue") + 
  facet_grid(sim_type~., scales = "free") +
  theme(legend.position = "bottom",
        strip.background = element_rect(fill="white")) +
  ylab("Density") + ggtitle("Distributions on Predicted Values (WaH)") + xlim(c(0, 20))
```

```{r, fig.width=12, fig.height=15}
(wa_look + theme(legend.position = "none")) / (h_look + theme(legend.position = "right")) / 
  (pred_look + theme(legend.position = "none"))
```

## H & WaH

### Coverage for H

```{r}
bs_vci_metrics %>% 
  filter(side == "h") %>% 
  group_by(data, method) %>% 
  unnest(prop) %>% 
  summarise(qs = quantile(prop, c(0.25, 0.5, 0.75)), prob = c(0.25, 0.5, 0.75),
            Mean = mean(prop),
            Max = max(prop),
            Min = min(prop)) %>% 
  pivot_wider(names_from = "prob",
              values_from = "qs") %>% 
  ungroup() %>% 
  dplyr::select(Simulations = data, Method = method, Min, `0.25`, `0.5`, Mean, `0.75`, Max) %>% 
  mutate_if(is.numeric, round, 2) %>%
  slice(3,4, 5,6, 1,2) %>% 
  knitr::kable(caption = "Coverage for BN2MF loadings")
```

### Coverage for WaH

```{r}
bs_vci_metrics %>% 
  filter(side == "pred") %>% 
  group_by(data, method) %>% 
  unnest(prop) %>% 
  summarise(qs = quantile(prop, c(0.25, 0.5, 0.75)), prob = c(0.25, 0.5, 0.75),
            Mean = mean(prop),
            Max = max(prop),
            Min = min(prop)) %>% 
  pivot_wider(names_from = "prob",
              values_from = "qs") %>% 
  ungroup() %>% 
  dplyr::select(Simulations = data, Method = method, Min, `0.25`, `0.5`, Mean, `0.75`, Max) %>% 
  mutate_if(is.numeric, round, 2) %>%
  slice(3,4, 5,6, 1,2) %>% 
  knitr::kable(caption = "Coverage for BN2MF predicted values")
```
