---
title: "GNMF & Sim Data -- Iterate"
author: "Lizzy Gibson"
date: "2/25/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)

knitr::opts_chunk$set(cache = TRUE)
```

# Load Sims

```{r, load}
load(here::here("./R/Sims/Iterate/sim_dist.RDA"))
sim_dist

load(here::here("./R/Sims/Iterate/sim_cor.RDA"))
sim_cor

load(here::here("./R/Sims/Iterate/sim_over.RDA"))
sim_over

labels <-  c("pcb28", "pcb66", "pcb74", "pcb99", "pcb105", "pcb118", "pcb138_158", "pcb146", "pcb153", "pcb156", "pcb167",
          "pcb170", "pcb178", "pcb183", "pcb187", "pcb180", "pcb189", "pcb194", "pcb196_203", "pcb199", "pcb206", "pcb209",
          "BDE17", "BDE28", "BDE47", "BDE66", "BDE85", "BDE99", "BDE100", "BDE153", "BDE154", "BDE183", "BDE209", "MECPP",
          "MEHHP", "MEOHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "MEHP", "dcp_24", "dcp_25", "b_pb", "bp_3", "m_pb",
          "p_pb", "tcs", "bpa")
```

# 1. Distinct Patterns

```{r, npb1}
get_eh_dist <- function(seed) {
  eh <- readMat(here::here(paste0("./R/Sims/Iterate_Out/eh_dist_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_dist <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_dist(.x)))

for (i in 1:100) {
  colnames(eh_dist$eh[[i]]) <- labels
  
  eh_dist$eh[[i]] <- eh_dist$eh[[i]]
  }

eh_dist_unnest <- eh_dist %>% 
  unnest(cols = c(eh))
```

## Scores

```{r, npb2}
get_ewa_dist <- function(seed) {
  ewa <- readMat(here::here(paste0("./R/Sims/Iterate_Out/ewa_dist_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_dist <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_dist(.x)))

ewa_dist_unnest <- ewa_dist %>% 
  unnest(cols = c(ewa))
```

## Match & Arrange

```{r, npb3}
npb_full_dist <- full_join(eh_dist, ewa_dist, by = "seed") %>% 
    full_join(., sim_dist, by = "seed")

## Match Functions
truth <- npb_scores_matched_dist[1,5][[1]][[1]]
loading <- npb_scores_matched_dist[1,2][[1]][[1]]

match_nmf_patterns <- function (truth, loading) {
  truth <- t(truth)
  
  if (nrow(truth) != nrow(loading)) {loading <- t(as.matrix(loading))} else {loading <- as.matrix(loading)}
  
  corr <- cor(truth, loading)
  
  reordered <- matrix(nrow = ncol(loading), ncol = nrow(loading))
  
  reordered[1,] <- loading[,which(corr==max(corr[1,]), arr.ind = TRUE)[2]]
  reordered[2,] <- loading[,which(corr==max(corr[2,]), arr.ind = TRUE)[2]]
  reordered[3,] <- loading[,which(corr==max(corr[3,]), arr.ind = TRUE)[2]]
  
  if (ncol(loading) >= 4) {reordered[4,] <- loading[,which(corr==max(corr[4,]), arr.ind = TRUE)[2]]}
  
  if (ncol(loading) == 5) {
    
    no <- c(which(corr==max(corr[1,]), arr.ind = TRUE)[2],
            which(corr==max(corr[2,]), arr.ind = TRUE)[2],
            which(corr==max(corr[3,]), arr.ind = TRUE)[2],
            which(corr==max(corr[4,]), arr.ind = TRUE)[2])
    
    reordered[5,] <- loading[,-no]
  }
  reordered
}

match_nmf_scores <- function (rotations_un, rotations, scores_un) {
  
  scores <- as_tibble(matrix(nrow = nrow(scores_un), ncol = ncol(scores_un)))
  
  for (k in 1:nrow(rotations_un)) {
    for (j in 1:nrow(rotations)) {
        if (all(rotations_un[k, ] == rotations[j, ])) {
          scores[, j] = scores_un[, k]
        }}
      }
  scores
}

npb_scores_matched_dist <- npb_full_dist %>% 
    mutate(npbnmf_loadings = map2(true_patterns, eh, match_nmf_patterns),
         npbnmf_scores = pmap(list(eh, npbnmf_loadings, ewa), 
                              match_nmf_scores))
```

## Symmetric Distance

```{r}
### Symmetric Subspace Distance
symm_subspace_dist <- function(U, V) {
  
  if (nrow(U) != max(nrow(U), ncol(U))) {U <- t(U)}
  if (nrow(V) != max(nrow(V), ncol(V))) {V <- t(V)}
  
  qrU <- qr.Q(qr(U))
  qrV <- qr.Q(qr(V))
  
  m <- ncol(U)
  n <- ncol(V)
  
  dUV <- sqrt( max(m,n) - sum((t(qrU) %*% qrV)^2) )
  
  ratio <- dUV/sqrt( max(m,n))
  
  ratio
  
}
```

```{r}
npb_scores_matched_dist %>% 
  mutate(symm_ratio = map2(true_scores, npbnmf_scores, symm_subspace_dist)) %>% 
  dplyr::select(seed, number_patterns, symm_ratio) %>% 
  unnest(cols = c(number_patterns, symm_ratio)) %>% dplyr::select(symm_ratio) %>%
  ggplot(aes(x = symm_ratio)) + geom_histogram(bins = 100) +
  theme_minimal() +
  labs(y = "Count", x = "Symmetric Subspace Distance Ratio")
```

# 2. Correlated Scores

```{r, npb5}
get_eh_cor <- function(seed) {
  eh <- readMat(here::here(paste0("./R/Sims/Iterate_Out/eh_cor_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_cor <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_cor(.x)))

for (i in 1:100) {
  colnames(eh_cor$eh[[i]]) <- labels
  
  eh_cor$eh[[i]] <- eh_cor$eh[[i]]
  }

eh_cor_unnest <- eh_cor %>% 
  unnest(cols = c(eh)) 
```

## Scores

```{r, npb6}
get_ewa_cor <- function(seed) {
  ewa <- readMat(here::here(paste0("./R/Sims/Iterate_Out/ewa_cor_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_cor <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_cor(.x)))

ewa_cor_unnest <- ewa_cor %>% 
  unnest(cols = c(ewa))
```

## Match & Arrange

```{r, npb7}
npb_full_cor <- full_join(eh_cor, ewa_cor, by = "seed") %>% 
    full_join(., sim_cor, by = "seed")

npb_scores_matched_cor <- npb_full_cor %>% 
    mutate(npbnmf_loadings = map2(true_patterns, eh, match_nmf_patterns),
         npbnmf_scores = pmap(list(eh, npbnmf_loadings, ewa), 
                              match_nmf_scores))
```

## Symmetric Distance

```{r}
npb_scores_matched_cor %>% 
  mutate(symm_ratio = map2(true_scores, npbnmf_scores, symm_subspace_dist)) %>% 
  dplyr::select(seed, symm_ratio) %>% 
  unnest(cols = c(symm_ratio)) %>%
  ggplot(aes(x = symm_ratio)) + geom_histogram(bins = 100) +
  theme_minimal() +
  labs(y = "Count", x = "Symmetric Subspace Distance Ratio")
```

# 3. Overlapping Patterns

```{r, npb9}
get_eh_over <- function(seed) {
  eh <- readMat(here::here(paste0("./R/Sims/Iterate_Out/eh_over_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_over <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_over(.x)))

for (i in 1:100) {
  colnames(eh_over$eh[[i]]) <- labels
  
  eh_over$eh[[i]] <- eh_over$eh[[i]]
  }

eh_over_unnest <- eh_over %>% 
  unnest(cols = c(eh))
```

## Scores

```{r, npb10}
get_ewa_over <- function(seed) {
  ewa <- readMat(here::here(paste0("./R/Sims/Iterate_Out/ewa_over_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_over <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_over(.x)))

ewa_over_unnest <- ewa_over %>% 
  unnest(cols = c(ewa))
```

## Match & Arrange

```{r, npb11}
npb_full_over <- full_join(eh_over, ewa_over, by = "seed") %>% 
    full_join(., sim_over, by = "seed")

npb_scores_matched_over <- npb_full_over %>% 
    mutate(npbnmf_loadings = map2(true_patterns, eh, match_nmf_patterns),
         npbnmf_scores = pmap(list(eh, npbnmf_loadings, ewa), 
                              match_nmf_scores))
```

## Symmetric Distance

```{r}
npb_scores_matched_over %>% 
  mutate(symm_ratio = map2(true_scores, npbnmf_scores, symm_subspace_dist)) %>% 
  dplyr::select(seed, symm_ratio) %>% 
  unnest(cols = c(symm_ratio)) %>%
  ggplot(aes(x = symm_ratio)) + geom_histogram(bins = 100) +
  theme_minimal() +
  labs(y = "Count", x = "Symmetric Subspace Distance Ratio")
```

# Summarize

## Rank

```{r, npb13}
npb_rank_d <- eh_dist %>% 
  group_by(seed) %>% 
  summarise(rank = n()) %>% 
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Distinct") %>%
  mutate(Proportion = n/100) %>%
  dplyr::select(Simulation, Rank = rank, Proportion)

npb_rank_o <- eh_over %>% 
  group_by(seed) %>% 
  summarise(rank = n()) %>% 
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Overlapping") %>%
  mutate(Proportion = n/100) %>%
  dplyr::select(Simulation, Rank = rank, Proportion)

npb_rank_c <- eh_cor %>% 
  unnest() %>% 
  group_by(seed) %>% 
  summarise(rank = n()) %>% 
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Correlated") %>%
  mutate(Proportion = n/100) %>%
  dplyr::select(Simulation, Rank = rank, Proportion)


rbind(npb_rank_d, npb_rank_o, npb_rank_c) %>% knitr::kable()
```
