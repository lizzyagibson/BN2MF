---
title: "GNMF & Sim Data -- Iterate"
author: "Lizzy Gibson"
date: "2/25/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
```

## Load Sims

```{r}
load("./Sims/Iterate/sim_dist.RDA")
sim_dist

load("./Sims/Iterate/sim_cor.RDA")
sim_cor

load("./Sims/Iterate/sim_over.RDA")
sim_over
```

## GNMF Results

### 1. Distinct Patterns

```{r}
get_eh_dist <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_dist_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_dist_raw <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_dist(.x)))

for (i in 1:100) {
  colnames(eh_dist_raw$eh[[i]]) <- labels
  
  eh_dist_raw$eh[[i]] <- eh_dist_raw$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }
```

```{r}
eh_dist_unnest <- eh_dist_raw %>% 
  unnest(cols = c(eh))

# Reorder patterns
eh_dist_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

eh_dist <- eh_dist_unnest %>% 
  # mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
  #                         ifelse(BDE17 > 0.5, 2,
  #                               ifelse(MECPP > 0.5, 3,
  #                                      ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
  # select(seed, pattern1, everything()) %>% 
  # arrange(seed, pattern1) %>% 
  # mutate(pattern1 = fct_inorder(as.factor(pattern1)),
  #        pattern1 = as.integer(pattern1)) %>% 
  select(-pattern) %>% 
  nest(eh = pcb28:bpa) #, eh_match = pattern:pattern1) # %>% 
  # mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  # mutate(eh = map(eh, ~div_sd(.x)))
```

#### Scores

```{r}
get_ewa_dist <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_dist_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_dist_raw <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_dist(.x)))

ewa_dist_unnest <- ewa_dist_raw %>% 
  unnest(cols = c(ewa))
```

#### Norms

```{r}
full_dist <- full_join(eh_dist, ewa_dist_raw, by = "seed") %>% 
    full_join(., sim_dist, by = "seed") %>% 
  select(-chem)

# All
full_dist %>%
  filter(!(seed %in% c(19, 21, 39))) %>% 
  mutate(ewa = map(ewa, as.matrix),
         eh = map(eh, as.matrix)) %>% 
  mutate(pred = map2(ewa, eh, `%*%`)) %>% 
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

# Loadings
eh_dist_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
  select(seed, pattern1, everything()) %>%
  arrange(seed, pattern1) %>%
  mutate(pattern1 = fct_inorder(as.factor(pattern1)),
         pattern1 = as.integer(pattern1)) %>%
  select(-pattern) %>% 
  nest(eh = pcb28:bpa, eh_match = pattern1) %>% 
  left_join(., sim_dist, by = "seed") %>% 
  filter(!(seed %in% c(19, 21, 39))) %>% 
  mutate(norm_loadings = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary()
# this is really good when both are standardized
```

#### Viz

```{r}
eh_dist_unnest %>%  
  filter(seed == 5) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_dist_unnest %>%  
  group_by(seed) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_dist_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

### 2. Correlated Scores

```{r}
get_eh_cor <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_cor_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_cor_raw <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_cor(.x)))

for (i in 1:100) {
  colnames(eh_cor_raw$eh[[i]]) <- labels
  
  eh_cor_raw$eh[[i]] <- eh_cor_raw$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }

eh_cor_unnest <- eh_cor_raw %>% 
  unnest(cols = c(eh)) 
```

```{r}
# Reorder patterns
eh_cor_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

eh_cor <- eh_cor_unnest %>% 
  # mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
  #                         ifelse(BDE17 > 0.5, 2,
  #                               ifelse(MECPP > 0.5, 3,
  #                                      ifelse(tcs > 0.5, 4, 5))))) %>% 
  # select(seed, pattern1, everything()) %>% 
  # arrange(seed, pattern1) %>% 
  # mutate(pattern1 = fct_inorder(as.factor(pattern1)),
  #        pattern1 = as.integer(pattern1)) %>% 
  select(-pattern) %>% 
  nest(eh = pcb28:bpa) #, eh_match = pattern:pattern1) # %>% 
  # mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  # mutate(eh = map(eh, ~div_sd(.x)))
```

#### Scores

```{r}
get_ewa_cor <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_cor_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_cor_raw <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_cor(.x)))

ewa_cor_unnest <- ewa_cor_raw %>% 
  unnest(cols = c(ewa))
```

#### Norm

```{r}
full_cor <- full_join(eh_cor, ewa_cor_raw, by = "seed") %>% 
    full_join(., sim_cor, by = "seed") %>% 
    select(-chem) %>% 
    mutate(new_ewa = map(ewa, ~.x[NA,]))

# All
full_cor %>%
  mutate(ewa = map(ewa, as.matrix),
         eh = map(eh, as.matrix)) %>% 
  mutate(pred = map2(ewa, eh, `%*%`)) %>% 
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

# Loadings
eh_cor_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
  select(seed, pattern1, everything()) %>%
  arrange(seed, pattern1) %>%
  mutate(pattern1 = fct_inorder(as.factor(pattern1)),
         pattern1 = as.integer(pattern1)) %>%
  select(-pattern) %>% 
  nest(eh = pcb28:bpa, eh_match = pattern1) %>% 
  left_join(., sim_dist, by = "seed") %>% 
  filter(!(seed %in% c(19, 21, 39))) %>% 
  mutate(norm_loadings = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary()
```

#### Viz

```{r}
eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  filter(seed == 3) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

### 3. Overlapping Patterns

```{r}
get_eh_over <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_over_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_over_raw <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_over(.x)))

for (i in 1:100) {
  colnames(eh_over_raw$eh[[i]]) <- labels
  
  eh_over_raw$eh[[i]] <- eh_over_raw$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }

eh_over_unnest <- eh_over_raw %>% 
  unnest(cols = c(eh))

eh_over_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

eh_over <- eh_over_unnest %>% 
  # mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
  #                         ifelse(BDE17 > 0.5, 2,
  #                               ifelse(MECPP > 0.5, 3,
  #                                      ifelse(tcs > 0.5, 4, 5))))) %>% 
  # select(seed, pattern1, everything()) %>% 
  # arrange(seed, pattern) %>% 
  # mutate(pattern1 = fct_inorder(as.factor(pattern1)),
  #        pattern1 = as.integer(pattern1)) %>% 
  select(-pattern) %>% 
  nest(eh = pcb28:bpa) #, eh_match = pattern:pattern1) # %>% 
  # mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  # mutate(eh = map(eh, ~div_sd(.x)))
```

#### Scores

```{r}
get_ewa_over <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_over_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_over_raw <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_over(.x)))

ewa_over_unnest <- ewa_over_raw %>% 
  unnest(cols = c(ewa))
```

#### Norms

```{r}
full_over <- full_join(eh_over, ewa_over_raw, by = "seed") %>% 
    full_join(., sim_over, by = "seed")

# All
full_over %>%
  filter(!(seed %in% c(26, 64))) %>% # Two seeds with 5 patterns
  mutate(ewa = map(ewa, as.matrix),
         eh = map(eh, as.matrix)) %>% 
  mutate(pred = map2(ewa, eh, `%*%`)) %>% 
  mutate(norm_all = map2(sim, pred, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary()

# Loadings
eh_over_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
  select(seed, pattern1, everything()) %>%
  arrange(seed, pattern1) %>%
  mutate(pattern1 = fct_inorder(as.factor(pattern1)),
         pattern1 = as.integer(pattern1)) %>%
  select(-pattern) %>% 
  nest(eh = pcb28:bpa, eh_match = pattern1) %>% 
  left_join(., sim_dist, by = "seed") %>% 
  filter(!(seed %in% c(26, 64))) %>% 
  mutate(norm_loadings = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary()
```

#### Viz

```{r}
eh_over_unnest %>%  
  filter(seed == 1) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_over_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_over_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

