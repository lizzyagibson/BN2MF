---
title: "GNMF & Sim Data -- Iterate"
author: "Lizzy Gibson"
date: "2/25/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
```

## 1: Distinct Patterns

### Simulate Patterns

Generate 4 non-negative vectors of length 50 “by hand” — vectors should be overlapping a bit, and at this stage don’t have to look too much like pollution. just make 20 (of 50) elements 1 and the rest 0.

Pattern matrix is 4*50, patterns by chemicals.

```{r}
## Construct a matrix for 4 TRUE exposure patterns
labels <-  c("pcb28", "pcb66", "pcb74", "pcb99", "pcb105", "pcb118", "pcb138_158", "pcb146", "pcb153", "pcb156", "pcb167",
          "pcb170", "pcb178", "pcb183", "pcb187", "pcb180", "pcb189", "pcb194", "pcb196_203", "pcb199", "pcb206", "pcb209",
          "BDE17", "BDE28", "BDE47", "BDE66", "BDE85", "BDE99", "BDE100", "BDE153", "BDE154", "BDE183", "BDE209", "MECPP",
          "MEHHP", "MEOHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "MEHP", "dcp_24", "dcp_25", "b_pb", "bp_3", "m_pb",
          "p_pb", "tcs", "bpa")

div_sd <- function (vars) {
  out <- apply(vars, 2, function(x) x/sd(x))}

create_patterns_dist <- function (seed) {
  set.seed(seed)
  patterns_dist <- rbind(c(runif(22, 1, 2), rep(0, 11), rep(0, 17)),
                       c(rep(0, 22), runif(11, 1, 2), rep(0, 17)),
                       c(rep(0, 33), runif(9, 1, 2), rep(0, 8)),
                       c(rep(0, 33), rep(0, 9), runif(8, 1, 2)))
  colnames(patterns_dist) <- labels
  patterns_dist
  #patterns_dist <- as_tibble(patterns_dist)
}

patterns_dist_iter <- tibble(seed = 1:100) %>% 
 mutate(patterns = map(seed, ~create_patterns_dist(seed = .x)) #,
        #patterns = map(patterns, ~div_sd(vars = .x))
        )

patterns_dist_iter[1,2][[1]]
```

### Simulate Scores

```{r}
create_scores_dist <- function (seed) {
  scores_dist <- matrix(nrow = 1000, ncol = 4)
  set.seed(seed)
  scores_dist <- exp(mvrnorm(n = 1000, mu = rep(1, 4), 
                          Sigma = diag(rep(1, 4)))) # Independent log normal dist
  scores_dist
}

scores_dist_iter <- tibble(seed = 1:100) %>% 
 mutate(scores = map(seed, ~create_scores_dist(seed = .x)))

scores_dist_iter
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_dist0 <- full_join(scores_dist_iter, patterns_dist_iter, by = "seed")

sim_dist0 <- sim_dist0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`)) # for matrix multiply to work, both must be matrices
```

### Simulate Noise

```{r}
add_noise <- function (seed, chem) {
  noise <- list(mean=0, sd=1)
  set.seed(seed)
  chem_dist <- pmax(chem + rmatrix(1000, 50, dist=rnorm, mean=noise$mean, sd=noise$sd), 0)	
  chem_dist
}

sim_dist <- sim_dist0 %>% 
 mutate(sim = map2(seed, chem, ~add_noise(seed = .x, chem = .y)))

sim_dist
```  

### Visualize

```{r, echo = FALSE, fig.height = 7}
chem_dist <- sim_dist$sim[[30]] %>% 
  as_tibble(.)

cormat <- round(cor(chem_dist, use = "complete.obs"),2)

melted_cormat <- melt(cormat) %>% rename(Correlation = value)

ggplot(data = melted_cormat, aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent", limits = c(-1, 1)) +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside", legend.position = "bottom")
```

### Save

```{r}
#for (i in 1:nrow(sim_dist)) {
#  write_csv(as_tibble(sim_dist[i,]$sim[[1]]), paste0("./Sims/Iterate/sim_dist_", i, ".csv"))  
#}
```

## 2: Correlated Patterns

### Simulate Patterns

```{r}
## Construct a matrix for 4 TRUE exposure patterns
create_patterns_cor <- function (seed) {
  set.seed(seed)
  patterns_cor <- rbind(c(runif(22, 1, 2),   runif(11, 0.5, 1), rep(0, 17)),
                         c(rep(0, 22),        runif(11, 1, 2),   runif(9, 0.5, 1),  rep(0, 8)),
                         c(rep(0, 33),                           runif(9, 1, 2),    runif(8, 0.5, 1)),
                         c(runif(22, 0.5, 1), rep(0, 11),        rep(0, 9),         runif(8, 1, 2)))
  
  colnames(patterns_cor) <- labels
  patterns_cor
}

patterns_cor_iter <- tibble(seed = 1:100) %>% 
 mutate(patterns = map(seed, ~create_patterns_cor(seed = .x)) #,
        #patterns = map(patterns, ~div_sd(vars = .x))
        )

patterns_cor_iter
```

### Simulate Scores

```{r}
create_scores_cor <- function (seed) {
  scores_cor <- matrix(nrow = 1000, ncol = 4)
  cov <- matrix( c(1,    0.25, 0.15, 0.15,
                  0.25, 1,    0.15, 0.15,
                  0.15, 0.15, 1,    0.25,
                  0.15, 0.15, 0.25, 1), nrow = 4)
  
  set.seed(seed)
  scores_cor <- exp(mvrnorm(n = 1000, mu = rep(1, 4), 
                          Sigma = cov)) # dists are kind of DEPENDENT
  }

scores_cor_iter <- tibble(seed = 1:100) %>% 
 mutate(scores = map(seed, ~create_scores_cor(seed = .x)))

scores_cor_iter
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_cor0 <- full_join(scores_cor_iter, patterns_cor_iter, by = "seed")

sim_cor0 <- sim_cor0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`))
```

### Simulate Noise

```{r}
sim_cor <- sim_cor0 %>% 
 mutate(sim = map2(seed, chem, ~add_noise(seed = .x, chem = .y)))

sim_cor
```  

### Visualize

```{r, echo = FALSE, fig.height = 7}
chem_cor <- sim_cor$sim[[5]] %>% 
  as_tibble(.)

cormat <- round(cor(chem_cor, use = "complete.obs"),2)

melted_cormat <- melt(cormat) %>% rename(Correlation = value)

ggplot(data = melted_cormat, aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent", limits = c(-1, 1)) +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside", legend.position = "bottom")
```

### Save

```{r}
#for (i in 1:nrow(sim_cor)) {
#  write_csv(as_tibble(sim_cor[i,]$sim[[1]]), paste0("./Sims/Iterate/sim_cor_", i, ".csv"))  
#}
```

## 3: Overlapping Patterns

### Simulate Patterns

Use correlated patterns.

### Simulate Scores

Use distinct scores.

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_over0 <- full_join(scores_dist_iter, patterns_cor_iter, by = "seed")

sim_over0 <- sim_over0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`))
```

### Simulate Noise

```{r}
sim_over <- sim_over0 %>% 
 mutate(sim = map2(seed, chem, ~add_noise(seed = .x, chem = .y)))
```  

### Visualize

```{r, echo = FALSE, fig.height = 7}
chem_over <- sim_over$sim[[5]] %>% 
  as_tibble(.)

cormat <- round(cor(chem_over, use = "complete.obs"),2)

melted_cormat <- melt(cormat) %>% rename(Correlation = value)

ggplot(data = melted_cormat, aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent", limits = c(-1, 1)) +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text.x = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside", legend.position = "bottom")
```

### Save

```{r}
#for (i in 1:nrow(sim_over)) {
#  write_csv(as_tibble(sim_over[i,]$sim[[1]]), paste0("./Sims/Iterate/sim_over_", i, ".csv"))  
#}
```

## GNMF Results

### Distinct Patterns

```{r}
get_eh <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_dist_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_dist <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh(.x)))

for (i in 1:100) {
  colnames(eh_dist$eh[[i]]) <- labels
  
  eh_dist$eh[[i]] <- eh_dist$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }
```

```{r}
eh_dist_unnest <- eh_dist %>% 
  unnest(cols = c(eh)) %>% select(-pattern)

# Reorder patterns
eh_dist_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

full_dist <- eh_dist_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  select(seed, pattern1, everything()) %>% 
  arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(as.factor(pattern1))) %>% 
  select(-pattern1) %>% 
  nest(eh = pcb28:bpa) %>% 
  full_join(., patterns_dist_iter, by = "seed") %>% 
  mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  mutate(eh = map(eh, ~div_sd(.x)))

full_dist %>% 
  # filter(!(seed %in% c(30,85))) %>% # Two seeds with 5 patterns
  mutate(norm = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm) %>% 
  pull(norm) %>% summary()
# this is really good when both are standardized
```

#### Viz

```{r}
eh_dist_unnest %>%  
  filter(seed == 4) %>% 
  mutate(pattern = 1:4) %>% 
  gather(key = Chemicals, value = Loadings, -pattern, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_dist_unnest %>%  
  group_by(seed) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_dist_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

#### Scores

```{r}
get_ewa <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_dist_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_dist <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa(.x)))

ewa_dist_unnest <- ewa_dist %>% 
  unnest(cols = c(ewa))

ewa_dist_unnest
```

### Correlated Scores

```{r}
get_eh_cor <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_cor_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_cor <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_cor(.x)))

for (i in 1:100) {
  colnames(eh_cor$eh[[i]]) <- labels
  
  eh_cor$eh[[i]] <- eh_cor$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }

eh_cor_unnest <- eh_cor %>% 
  unnest(cols = c(eh)) %>% select(-pattern)
```

```{r}
# Reorder patterns
eh_cor_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

full_cor <- eh_cor_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  select(seed, pattern1, everything()) %>% 
  arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(as.factor(pattern1))) %>% 
  select(-pattern1) %>% 
  nest(eh = pcb28:bpa) %>% 
  full_join(., patterns_dist_iter, by = "seed") %>% 
  mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  mutate(eh = map(eh, ~div_sd(.x)))

full_cor %>% 
  #filter(!(seed %in% c(30,85)))
  mutate(norm = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm) %>% 
  pull(norm) %>% summary()
# this is really good when both are standardized
```

#### Viz

```{r}
eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  filter(seed == 3) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_cor_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

#### Scores

```{r}
get_ewa_cor <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_cor_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_cor <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_cor(.x)))

ewa_cor_unnest <- ewa_cor %>% 
  unnest(cols = c(ewa))

ewa_cor_unnest
```

### Overlapping Patterns

```{r}
get_eh_over <- function(seed) {
  eh <- readMat(paste0("./Sims/Iterate_Out/eh_over_", seed, ".mat"))[[1]]
  eh <- as_tibble(eh)
}

eh_over <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_over(.x)))

for (i in 1:100) {
  colnames(eh_over$eh[[i]]) <- labels
  
  eh_over$eh[[i]] <- eh_over$eh[[i]] %>% 
                      mutate(pattern = 1:nrow(.)) %>% 
                      select(pattern, everything())
  }

eh_over_unnest <- eh_over %>% 
  unnest(cols = c(eh)) %>% select(-pattern)

eh_over_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()

full_over <- eh_over_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  select(seed, pattern1, everything()) %>% 
  arrange(seed, pattern1) %>% 
  mutate(pattern1 = fct_inorder(as.factor(pattern1))) %>% 
  select(-pattern1) %>% 
  nest(eh = pcb28:bpa) %>% 
  full_join(., patterns_cor_iter, by = "seed") %>% 
  mutate(patterns = map(patterns, ~div_sd(.x))) %>% # ???
  mutate(eh = map(eh, ~div_sd(.x)))

full_over %>% filter(seed == 26)

full_over %>% 
  filter(!(seed %in% c(26, 64))) %>% # Two seeds with 5 patterns
  mutate(norm = map2(patterns, eh, ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm) %>% 
  pull(norm) %>% summary()
```

#### Viz

```{r}
norm(as.matrix(full_over[1,]$patterns[[1]]) - as.matrix(full_over[1,]$eh[[1]]), type = "F")/norm(as.matrix(full_over[1,]$patterns[[1]]), type = "F")

full_over[1,]$patterns[[1]]
full_over[1,]$eh[[1]]

eh_over_unnest %>%  
  filter(seed == 1) %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())

eh_over_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.1, height = 0) +
  geom_boxplot(aes(x = Group, color = Group), width = .45, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank())
```

```{r}
eh_over_unnest %>%  
  mutate(pattern1 = ifelse(pcb146 > 0.5, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  group_by(Chemicals, pattern1) %>% 
  summarise(med = median(Loadings),
            upper = quantile(Loadings, 0.75),
            lower = quantile(Loadings, 0.25)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = med)) + 
  geom_pointrange(aes(color = Group, min = lower, max = upper), alpha = 0.75, size = 0.25) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

### Scores

```{r}
get_ewa_over <- function(seed) {
  ewa <- readMat(paste0("./Sims/Iterate_Out/ewa_over_", seed, ".mat"))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_over <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa(.x)))

ewa_over_unnest <- ewa_over %>% 
  unnest(cols = c(ewa))

ewa_over_unnest
```
