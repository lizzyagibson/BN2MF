---
title: "npBMF, NMF, PCA, FA, & Sims"
author: "Lizzy Gibson"
date: "3/20/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    code_folding: hide
---

```{r setup, include=FALSE}
options(scipen = 999)
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
library(psych)
library(RColorBrewer)

knitr::opts_chunk$set(cache = TRUE)
```

# Load Sims

```{r, load}
load(here::here("./R/Sims/Iterate/sim_dist.RDA"))

load(here::here("./R/Sims/Iterate/sim_cor.RDA"))

load(here::here("./R/Sims/Iterate/sim_over.RDA"))

labels <-  c("pcb28", "pcb66", "pcb74", "pcb99", "pcb105", "pcb118", "pcb138_158", "pcb146", "pcb153", "pcb156", "pcb167",
          "pcb170", "pcb178", "pcb183", "pcb187", "pcb180", "pcb189", "pcb194", "pcb196_203", "pcb199", "pcb206", "pcb209",
          "BDE17", "BDE28", "BDE47", "BDE66", "BDE85", "BDE99", "BDE100", "BDE153", "BDE154", "BDE183", "BDE209", "MECPP",
          "MEHHP", "MEOHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "MEHP", "dcp_24", "dcp_25", "b_pb", "bp_3", "m_pb",
          "p_pb", "tcs", "bpa")
```

# Distinct Patterns

## Non-parametric Bayesian NMF (npBNMF)
```{r, npb1}
get_eh_dist <- function(seed) {
  eh <- readMat(here::here(paste0("./Sims/Iterate_Out/eh_dist_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_dist <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_dist(.x)))

for (i in 1:100) {
  colnames(eh_dist$eh[[i]]) <- labels
  
  eh_dist$eh[[i]] <- eh_dist$eh[[i]]
  }

eh_dist_unnest <- eh_dist %>% 
  unnest(cols = c(eh))

# Reorder patterns
eh_dist_unnest %>% 
  mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
                          ifelse(BDE17 > 0.5, 2,
                                ifelse(MECPP > 0.5, 3,
                                       ifelse(tcs > 0.5, 4, 5))))) %>% pull(pattern1) %>% table()
```

### Scores
```{r, npb2}
get_ewa_dist <- function(seed) {
  ewa <- readMat(here::here(paste0("./Sims/Iterate_Out/ewa_dist_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_dist <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_dist(.x)))

ewa_dist_unnest <- ewa_dist %>% 
  unnest(cols = c(ewa))
```

### Match & Arrange

**Match loadings based on correlation with true patterns**

```{r, npb3}
npb_full_dist <- full_join(eh_dist, ewa_dist, by = "seed") %>% 
    full_join(., sim_dist, by = "seed") %>% 
  select(-chem)

# match_patterns_npb <- function (eh_unnested) {
#   eh_reordered <- eh_unnested %>% 
#   mutate(pattern1 = ifelse(pcb146 > 0.5 & pcb28 > bpa, 1,
#                           ifelse(BDE17 > 0.5, 2,
#                                 ifelse(MECPP > 0.5, 3,
#                                        ifelse(tcs > 0.5, 4, 5))))) %>% # Switch patterns later to compare EH to loadings
#   select(pattern1, everything())
#   eh_reordered
# }

# loading <- npb_full_dist$eh[[1]]
# #4 x 50
# truth <- npb_full_dist$patterns[[1]]
# #4x50
# loading <- rbind(loading, runif(50, min = 0.1, max = 0.50))

match_patterns_corr <- function (truth, loading) {
  truth <- t(truth)
  if (nrow(truth) != nrow(loading)) {loading <- t(as.matrix(loading))} else {loading <- as.matrix(loading)}
  
  corr <- cor(truth, loading)
  
  reordered <- matrix(nrow = ncol(truth) - 1, ncol = nrow(truth))
  
  reordered[1,] <- loading[,which(corr==max(corr[1,]), arr.ind = TRUE)[2]]
  reordered[2,] <- loading[,which(corr==max(corr[2,]), arr.ind = TRUE)[2]]
  reordered[3,] <- loading[,which(corr==max(corr[3,]), arr.ind = TRUE)[2]]
  
  if (ncol(loading) >= 4) {reordered <- rbind(reordered, loading[,which(corr==max(corr[4,]), arr.ind = TRUE)[2]])}
  
  if (ncol(loading) == 5) {
  
  no <- c(which(corr==max(corr[1,]), arr.ind = TRUE)[2],
          which(corr==max(corr[2,]), arr.ind = TRUE)[2],
          which(corr==max(corr[3,]), arr.ind = TRUE)[2],
          which(corr==max(corr[4,]), arr.ind = TRUE)[2])
  
  reordered <- rbind(reordered, loading[,-no])
  }
  reordered
}

# match <- match_patterns_corr(truth, loading)
# cor(t(truth), t(match))

# Need to change some parts of above so that we can match scores to patterns
match_scores_npb <- function (patterns, scores) {
  N <- nrow(scores)
  for (j in 1:nrow(patterns)) {
    for (i in 1:ncol(scores)) {
      if (patterns[j, 2] == j && scores[1, i] == j) {
        scores[(N+1),i] = patterns[j,1]
      }
    }
  } 
  scores <- scores[c(1, nrow(scores), 2:(nrow(scores) - 1)),]
  scores
}

match_scores_npb(npb_full_dist$eh[1][[1]], npb_full_dist$ewa[1][[1]])

npb_scores_matched_dist <- npb_full_dist %>% 
    mutate(eh_reordered = map2(patterns, eh, function(x,y) match_patterns_corr(truth = x, loading = y)),
         ewa_reordered = ewa,
         ewa_reordered = map2(eh_reordered, ewa_reordered, ~match_scores_npb(patterns = .x, scores = .y)))

# reorder_patterns_npb <- function (eh_unnested) {
#   eh_reordered <- eh_unnested %>% 
#   arrange(pattern1) %>%
#   mutate(pattern1 = fct_inorder(as.factor(pattern1)),
#          pattern1 = as.integer(pattern1)) %>% 
#     select(-pattern1, -pattern)
#   eh_reordered
# }

# reorder_scores_npb <- function (ewa_unnested) {
#   ewa_reordered <- ewa_unnested %>% 
#     t(.) %>% as_tibble(.) %>% 
#   arrange(V2) %>%
#   mutate(V2 = fct_inorder(as.factor(V2)),
#          V2 = as.integer(V2)) %>% 
#     t(.) %>% as_tibble(.) %>% 
#     slice(3:nrow(.))
#   ewa_reordered
# }

npb_scores_ordered_dist <- npb_scores_matched_dist # %>% 
#   mutate(eh_reordered = map(eh_reordered, ~reorder_patterns_npb(.x)),
#          ewa_reordered = map(ewa_reordered, ~reorder_scores_npb(.x)))
```

## PCA
```{r, pca1}
get_pca <- function (sim) {
  pca_out <- prcomp(sim)
  rotation <- as_tibble(pca_out$rotation)
  x <- as_tibble(pca_out$x)
  sv <- pca_out$sdev
  pred <- svd(sim)$u %*% diag(svd(sim)$d) %*% t(svd(sim)$v)
  list(rotation = rotation, ex = x, sv = sv, pred = pred)
}

pca_out_dist <- sim_dist %>% 
  mutate(rotations = map(sim, function(x) get_pca(x)[[1]]),
         ex = map(sim, function(x) get_pca(x)[[2]]),
         sv = map(sim, function(x) get_pca(x)[[3]]),
         pred = map(sim, function(x) get_pca(x)[[4]]))

#Explains > 80% variance
get_rank <- function (sv) {
  pve <- sv^2/sum(sv^2)
  rank <- 0
  for (i in 1:length(sv)) {
  if (sum(pve[1:i]) >= 0.8) {
    rank <- i
    break
  }}
    rank}

cut_rank <- function(rotations, ex, rank) {
  rotations <- rotations[, 1:rank] # this is variables x patterns
  ex <- ex[, 1:rank]
  list(rotations = rotations, ex = ex)
}
  
pca_out_dist <- pca_out_dist %>% 
  mutate(rank = map(sv, get_rank),
         rotations = pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[1]]),
         ex =        pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[2]]))
  
pca_rotations_dist <- pca_out_dist %>% select(seed, rotations) %>% unnest(cols = c(rotations))
```

### Match Scores
```{r, pca2}
#matche the loading directions to the first solution
#loading <- pca_out_dist$rotations[10][[1]]

match_eigen_first <- function (loading) {
  truth <- pca_out_dist$rotations[1][[1]]
  loading <- as.matrix(loading)
  corr <- diag(cor(truth, loading))
  
  reordered <- matrix(nrow = nrow(loading), ncol = ncol(loading))

for (i in 1:nrow(loading)) {  
  reordered[i,1] <- ifelse(corr[1] < 0, -loading[i,1], loading[i,1])
  reordered[i,2] <- ifelse(corr[2] < 0, -loading[i,2], loading[i,2])
  
  if (ncol(loading) == 3) {reordered[i,3] <- ifelse(corr[3] < 0, -loading[i,3], loading[i,3])}
}
  reordered
}

# cor(loading, truth)
# head(match_eigen_first(loading))
# head(loading)
# cor(match_eigen_first(pca_out_dist$rotations[3][[1]]))
# match_eigen_first(loading = loading)

# match_pca_scores <- function (rotations, rotations_re, ex) {
#   ex_re <- as_tibble(matrix(nrow = nrow(ex), ncol = ncol(ex)))
#    for (k in 1:ncol(rotations)) {
#       for (chem in 1:nrow(rotations)) {
#         for (i in 1:nrow(ex)) {
#         if (rotations[chem, k] == rotations_re[chem, k]) {
#           ex_re[i, k] = ex[i, k]
#         } else {ex_re[i, k] = -(ex[i, k])}
#         }}}
#   ex_re
# }

pca_scores_matched_dist <- pca_out_dist %>% 
  mutate(rotations_re = map(rotations, match_eigen_first))
# ,
  #        ex_re = pmap(list(rotations, rotations_re, ex), function(x,y,z)
  #          {match_pca_scores(as.matrix(x), as.matrix(y), as.matrix(z))} #match_pca_scores
  #                      ))
```

## Factor Analysis (FA)
```{r, fa1}
get_fa <- function (sim) {
  set.seed(1988)
  fa_3 <- fa(sim, 3, scores = "regression", rotate = "promax")
  fa_4 <- fa(sim, 4, scores = "regression", rotate = "promax")
  fa_5 <- fa(sim, 5, scores = "regression", rotate = "promax")
  
 if (fa_5$BIC < fa_4$BIC && fa_5$BIC < fa_3$BIC) {
    fa_out <- fa_5
  } else if (fa_4$BIC < fa_3$BIC && fa_4$BIC < fa_5$BIC) {
    fa_out <- fa_4
  } else {fa_out <- fa_3}
    
  loadings <- matrix(fa_out$loadings, ncol = ncol(fa_out$scores))
  fa_scores <- fa_out$scores
  pred <- fa_scores %*% t(loadings)
  list(fa_scores = fa_scores, loadings = loadings, pred = pred)
}

fa_out_dist <- sim_dist %>% 
  mutate(fa_out = map(sim, get_fa),
        loadings = map(fa_out, function(x){x[[2]]}),
        pred = map(fa_out, function(x){x[[3]]}),
        fa_scores = map(fa_out, function(x){x[[1]]}))

fa_loadings_dist <- fa_out_dist %>% select(seed, loadings) %>% 
        mutate(loadings = map(loadings, as_tibble)) %>% 
        unnest(loadings)
```

## Regular NMF 
```{r, nmf1}
get_nmf <- function (sim) {
  set.seed(1988)
  
  nmf_3 <- nmf(sim, 3, nrun = 50)
  nmf_4 <- nmf(sim, 4, nrun = 50)
  nmf_5 <- nmf(sim, 5, nrun = 50)
  
 if (cophcor(consensus(nmf_3)) >= cophcor(consensus(nmf_4))) {
    nmf_out <- nmf_3
  } else if (cophcor(consensus(nmf_4)) > cophcor(consensus(nmf_3)) && 
             cophcor(consensus(nmf_4)) >= cophcor(consensus(nmf_5))) {
    nmf_out <- nmf_4
  } else {nmf_out <- nmf_5}
  
  basis <- as_tibble(basis(nmf_out))
  coef <- as_tibble(coef(nmf_out))
  pred <- basis(nmf_out) %*% coef(nmf_out)
  list(basis = basis, coef = coef, pred = pred)
  }

nmf_out_dist <- sim_dist %>%
  mutate(nmf_out = map(sim, get_nmf),
        coef = map(nmf_out, function(x) {x[[2]]}),
         pred = map(nmf_out, function(x) {x[[3]]}),
         basis = map(nmf_out, function(x) {x[[1]]})) %>% 
  select(-chem)

nmf_coef_dist <- nmf_out_dist %>% select(seed, coef) %>% unnest(cols = c(coef))
```

### Match & Arrange

```{r, nmf2}
match_scores_nmf <- function (patterns, scores) {
  N <- nrow(scores)
  for (j in 1:nrow(patterns)) {
    for (i in 1:ncol(scores)) {
      if (patterns[j, 2] == j && scores[1, i] == j) {
        scores[(N+1), i] = patterns[j, 1]
      }
    }
  } 
  scores <- scores[c(1, nrow(scores), 2:(nrow(scores) - 1)),]
  scores
}

nmf_scores_matched_dist <- nmf_out_dist %>% 
    mutate(coef_reordered = map2(patterns, coef, function(x,y) match_patterns_corr(truth = x, loading = y)))
# ,
#          basis_reordered = map(basis, as_tibble),
#          basis_reordered = map2(coef_reordered, basis_reordered, ~match_scores_nmf(patterns = .x, scores = .y)))
```

```{r, nmfmore}
# reorder_patterns_nmf <- function (coef_unnested) {
#   coef_reordered <- coef_unnested %>% 
#   arrange(pattern1) %>%
#   mutate(pattern1 = fct_inorder(as.factor(pattern1)),
#          pattern1 = as.integer(pattern1)) %>% 
#     select(-pattern1, -pattern)
#   coef_reordered
# }
# 
# reorder_scores_nmf <- function (basis_unnested) {
#   basis_reordered <- basis_unnested %>% 
#     t(.) %>% as_tibble(.) %>% 
#   arrange(V2) %>%
#   mutate(V2 = fct_inorder(as.factor(V2)),
#          V2 = as.integer(V2)) %>% 
#     t(.) %>% as_tibble(.) %>% 
#     slice(3:nrow(.))
#   basis_reordered
# }
# 
nmf_scores_ordered_dist <- nmf_scores_matched_dist #%>% 
#   mutate(coef_reordered = map(coef_reordered, ~reorder_patterns_nmf(.x)),
#          basis_reordered = map(basis_reordered, ~reorder_scores_nmf(.x)))
```

## Viz

### PCA
```{r, pca3}
pca_rotations_dist %>%  
  filter(seed == 100) %>%  
  as_tibble(.) %>% 
  mutate(Chemicals = labels) %>% 
  gather(key = PC, value = Loadings, -Chemicals) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
    group_by(PC) %>%
  mutate(Loadings = case_when(
    any(PC == "PC1" & Chemicals == "pcb28" & Loadings < 0) ~ -Loadings,
    any(PC == "PC2" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    any(PC == "PC3" & Chemicals == "bpa" & Loadings < 0) ~ -Loadings,
    #any(PC == "PC4" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    TRUE ~ Loadings # These dont change plot at all, should be able to standardize all 100 sims
  )) %>% filter(PC %in% c("PC1", "PC2", "PC3")) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~PC) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width=8}
pca_scores_matched_dist %>%
  select(seed, rotations_re) %>% 
  mutate(rotations_re = map(rotations_re, as_tibble)) %>% 
  unnest(rotations_re) %>% 
  mutate(Chemicals = rep(labels, 100)) %>% 
  gather(key = PC, value = Loadings, -Chemicals, -seed) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~PC) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "PCA Loadings, Distinct Patterns", x = "", y = "Loadings")
```

### FA
```{r, fa2}
fa_loadings_dist %>%  
  filter(seed == 77) %>% 
  mutate(Chemicals = labels) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width=6}
fa_loadings_dist %>%  
  mutate(Chemicals = rep(labels, 100)) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "FA Loadings, Distinct Patterns", x = "", y = "Loadings")
```

# Overlapping Patterns

## npBNMF
```{r, npb9}
get_eh_over <- function(seed) {
  eh <- readMat(here::here(paste0("./Sims/Iterate_Out/eh_over_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_over <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_over(.x)))

for (i in 1:100) {
  colnames(eh_over$eh[[i]]) <- labels
  
  eh_over$eh[[i]] <- eh_over$eh[[i]]
  }

eh_over_unnest <- eh_over %>% 
  unnest(cols = c(eh))
```

### Scores
```{r, npb10}
get_ewa_over <- function(seed) {
  ewa <- readMat(here::here(paste0("./Sims/Iterate_Out/ewa_over_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_over <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_over(.x)))

ewa_over_unnest <- ewa_over %>% 
  unnest(cols = c(ewa))
```

### Match & Arrange
```{r, npb11}
npb_full_over <- full_join(eh_over, ewa_over, by = "seed") %>% 
    full_join(., sim_over, by = "seed") %>% 
  select(-chem)

npb_scores_matched_over <- npb_full_over %>% 
  mutate(eh_reordered = map2(patterns, eh, function(x,y) match_patterns_corr(truth = x, loading = y)))
#,
         # ewa_reordered = ewa,
         # ewa_reordered = map2(eh_reordered, ewa_reordered, ~match_scores_npb(patterns = .x, scores = .y)))

npb_scores_ordered_over <- npb_scores_matched_over # %>% 
  # mutate(eh_reordered = map(eh_reordered, ~reorder_patterns_npb(.x)),
  #        ewa_reordered = map(ewa_reordered, ~reorder_scores_npb(.x)))
```

## PCA
```{r, pca4}
pca_out_over <- sim_over %>% 
  mutate(rotations = map(sim, function(x) get_pca(x)[[1]]),
         ex = map(sim, function(x) get_pca(x)[[2]]),
         sv = map(sim, function(x) get_pca(x)[[3]]),
         pred = map(sim, function(x) get_pca(x)[[4]]))

pca_out_over <- pca_out_over %>% 
  mutate(rank = map(sv, get_rank),
         rotations = pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[1]]),
         ex =        pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[2]]))

pca_rotations_over <- pca_out_over %>% select(seed, rotations) %>% unnest(cols = c(rotations))
```

### Match Scores

```{r, pca5}
match_eigen_second <- function (loading) {
  truth <- pca_out_over$rotations[1][[1]]
  loading <- as.matrix(loading)
  corr <- diag(cor(truth, loading))
  
  reordered <- matrix(nrow = nrow(loading), ncol = ncol(loading))

for (i in 1:nrow(loading)) {  
  reordered[i,1] <- ifelse(corr[1] < 0, -loading[i,1], loading[i,1])
  reordered[i,2] <- ifelse(corr[2] < 0, -loading[i,2], loading[i,2])
  
  if (ncol(loading) == 3) {reordered[i,3] <- ifelse(corr[3] < 0, -loading[i,3], loading[i,3])}
}
  reordered
}

pca_scores_matched_over <- pca_out_over %>% 
  mutate(rotations_re = map(rotations, match_eigen_second))
# ,
#          ex_re = pmap(list(rotations, rotations_re, ex), function(x,y,z)
#            {match_pca_scores(as.matrix(x), as.matrix(y), as.matrix(z))} #match_pca_scores
#                        ))
```

## FA
```{r, fa3, warning=FALSE}
fa_out_over <- sim_over %>% 
  mutate(fa_out = map(sim, get_fa),
        loadings = map(fa_out, function(x){x[[2]]}),
        pred = map(fa_out, function(x){x[[3]]}),
        fa_scores = map(fa_out, function(x){x[[1]]}))

fa_loadings_over <- fa_out_over %>% select(seed, loadings) %>% 
  mutate(loadings = map(loadings, as_tibble)) %>% 
  unnest(loadings)
```

## NMF
```{r, nmf4}
nmf_out_over <- sim_over %>% 
    mutate(nmf_out = map(sim, get_nmf),
        coef = map(nmf_out, function(x) {x[[2]]}),
         pred = map(nmf_out, function(x) {x[[3]]}),
         basis = map(nmf_out, function(x) {x[[1]]})) %>% 
  select(-chem)

nmf_coef_over <- nmf_out_over %>% select(seed, coef) %>% unnest(cols = c(coef))
```

### Match & Arrange
```{r, nmf5}
nmf_scores_matched_over <- nmf_out_over %>% 
    mutate(coef_reordered = map2(patterns, coef, function(x,y) match_patterns_corr(truth = x, loading = y)))
# ,
#          basis_reordered = map(basis, ~as_tibble(.x)),
#          basis_reordered = map2(coef_reordered, basis_reordered, ~match_scores_nmf(patterns = .x, scores = .y)))

nmf_scores_ordered_over <- nmf_scores_matched_over 
# %>% 
#   mutate(coef_reordered = map(coef_reordered, ~reorder_patterns_nmf(.x)),
#          basis_reordered = map(basis_reordered, ~reorder_scores_nmf(.x)))
```

## Viz

### PCA
```{r, pca6}
pca_rotations_over %>%  
  filter(seed == 100) %>%  
  as_tibble(.) %>% 
  mutate(Chemicals = labels) %>% 
  gather(key = PC, value = Loadings, -Chemicals) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
    group_by(PC) %>%
  mutate(Loadings = case_when(
    any(PC == "PC1" & Chemicals == "pcb28" & Loadings < 0) ~ -Loadings,
    any(PC == "PC2" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    any(PC == "PC3" & Chemicals == "bpa" & Loadings < 0) ~ -Loadings,
    #any(PC == "PC4" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    TRUE ~ Loadings # These dont change plot at all, should be able to standardize all 100 sims
  )) %>% filter(PC %in% c("PC1", "PC2", "PC3")) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~PC) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width = 8}
pca_scores_matched_over %>%
  select(seed, rotations_re) %>% 
  unnest(rotations_re) %>% 
  mutate(Chemicals = rep(labels, 100)) %>% 
  gather(key = PC, value = Loadings, -Chemicals, -seed) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~PC) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "PCA Loadings, Overlapping Patterns", x = "", y = "Loadings")
```

### FA
```{r, fa4}
fa_loadings_over %>%  
  filter(seed == 7) %>% 
  mutate(Chemicals = labels) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width=6}
fa_loadings_over %>%  
  mutate(Chemicals = rep(labels, 100)) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "FA Loadings, Overlapping Patterns", x = "", y = "Loadings")
```

# Correlated Scores

## npBNMF
```{r, npb5}
get_eh_cor <- function(seed) {
  eh <- readMat(here::here(paste0("./Sims/Iterate_Out/eh_cor_", seed, ".mat")))[[1]]
  eh <- as_tibble(eh)
}

eh_cor <- tibble(seed = 1:100) %>% 
  mutate(eh = map(seed, ~get_eh_cor(.x)))

for (i in 1:100) {
  colnames(eh_cor$eh[[i]]) <- labels
  
  eh_cor$eh[[i]] <- eh_cor$eh[[i]]
  }

eh_cor_unnest <- eh_cor %>% 
  unnest(cols = c(eh)) 
```

### Scores
```{r, npb6}
get_ewa_cor <- function(seed) {
  ewa <- readMat(here::here(paste0("./Sims/Iterate_Out/ewa_cor_", seed, ".mat")))[[1]]
  ewa <- as_tibble(ewa)
}

ewa_cor <- tibble(seed = 1:100) %>% 
  mutate(ewa = map(seed, ~get_ewa_cor(.x)))

ewa_cor_unnest <- ewa_cor %>% 
  unnest(cols = c(ewa))
```

### Match & Arrange
```{r, npb7}
npb_full_cor <- full_join(eh_cor, ewa_cor, by = "seed") %>% 
    full_join(., sim_cor, by = "seed") %>% 
  select(-chem)

npb_scores_matched_cor <- npb_full_cor %>% 
  mutate(eh_reordered = map2(patterns, eh, function(x,y) match_patterns_corr(truth = x, loading = y)))
# ,
#          ewa_reordered = ewa,
#          ewa_reordered = map2(eh_reordered, ewa_reordered, ~match_scores_npb(patterns = .x, scores = .y)))

npb_scores_ordered_cor <- npb_scores_matched_cor 
# %>% 
#   mutate(eh_reordered = map(eh_reordered, ~reorder_patterns_npb(.x)),
#          ewa_reordered = map(ewa_reordered, ~reorder_scores_npb(.x)))
```

## PCA
```{r, pca7}
pca_out_cor <- sim_cor %>% 
  mutate(rotations = map(sim, function(x) get_pca(x)[[1]]),
         ex = map(sim, function(x) get_pca(x)[[2]]),
         sv = map(sim, function(x) get_pca(x)[[3]]),
         pred = map(sim, function(x) get_pca(x)[[4]]))

pca_out_cor <- pca_out_cor %>% 
  mutate(rank = map(sv, get_rank),
         rotations = pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[1]]),
         ex =        pmap(list(rotations, ex, rank), 
                          function(x,y,z) cut_rank(x,y,z)[[2]]))

pca_rotations_cor <- pca_out_cor %>% select(seed, rotations) %>% unnest(cols = c(rotations))
```

### Match Scores
```{r, pca8}
match_eigen_third <- function (loading) {
  truth <- pca_out_cor$rotations[1][[1]]
  loading <- as.matrix(loading)
  corr <- diag(cor(truth, loading))
  
  reordered <- matrix(nrow = nrow(loading), ncol = ncol(loading))

for (i in 1:nrow(loading)) {  
  reordered[i,1] <- ifelse(corr[1] < 0, -loading[i,1], loading[i,1])
  reordered[i,2] <- ifelse(corr[2] < 0, -loading[i,2], loading[i,2])
  
  if (ncol(loading) == 3) {reordered[i,3] <- ifelse(corr[3] < 0, -loading[i,3], loading[i,3])}
}
  reordered
}

pca_scores_matched_cor <- pca_out_cor %>% 
  mutate(rotations_re = map(rotations, match_eigen_third))
# ,
#          ex_re = pmap(list(rotations, rotations_re, ex), function(x,y,z)
#            {match_pca_scores(as.matrix(x), as.matrix(y), as.matrix(z))} #match_pca_scores
#                        ))
```

## FA
```{r, fa5, warning=FALSE}
fa_out_cor <- sim_cor %>% 
  mutate(fa_out = map(sim, get_fa),
        loadings = map(fa_out, function(x){x[[2]]}),
        pred = map(fa_out, function(x){x[[3]]}),
        fa_scores = map(fa_out, function(x){x[[1]]}))

fa_loadings_cor <- fa_out_cor %>% select(seed, loadings) %>% 
  mutate(loadings = map(loadings, as_tibble)) %>% 
  unnest(loadings)
```

## NMF
```{r, nmf7}
nmf_out_cor <- sim_cor %>% 
    mutate(nmf_out = map(sim, get_nmf),
        coef = map(nmf_out, function(x) {x[[2]]}),
         pred = map(nmf_out, function(x) {x[[3]]}),
         basis = map(nmf_out, function(x) {x[[1]]})) %>% 
  select(-chem)

nmf_coef_cor <- nmf_out_cor %>% select(seed, coef) %>% unnest(cols = c(coef))
```

### Match & Arrange
```{r, nmf8}
nmf_scores_matched_cor <- nmf_out_cor
# %>% 
    # mutate(coef_reordered = map2(truth, coef, function(x,y) match_patterns_corr(truth = x, loading = y)),
    #      basis_reordered = map(basis, ~as_tibble(.x)),
    #      basis_reordered = map2(coef_reordered, basis_reordered, ~match_scores_nmf(patterns = .x, scores = .y)))

# nmf_scores_ordered_cor <- nmf_scores_matched_cor %>% 
#   mutate(coef_reordered = map(coef_reordered, ~reorder_patterns_nmf(.x)),
#          basis_reordered = map(basis_reordered, ~reorder_scores_nmf(.x)))
```

## Viz

### PCA
```{r, pca9}
pca_rotations_cor %>%  
  filter(seed == 100) %>%  
  as_tibble(.) %>% 
  mutate(Chemicals = labels) %>% 
  gather(key = PC, value = Loadings, -Chemicals) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
    group_by(PC) %>%
  mutate(Loadings = case_when(
    any(PC == "PC1" & Chemicals == "pcb28" & Loadings < 0) ~ -Loadings,
    any(PC == "PC2" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    any(PC == "PC3" & Chemicals == "bpa" & Loadings < 0) ~ -Loadings,
    #any(PC == "PC4" & Chemicals == "BDE99" & Loadings < 0) ~ -Loadings,
    TRUE ~ Loadings # These dont change plot at all, should be able to standardize all 100 sims
  )) %>% filter(PC %in% c("PC1", "PC2", "PC3")) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~PC) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width=8}
pca_scores_matched_cor %>%
  select(seed, rotations_re) %>% 
  unnest(rotations_re) %>% 
  mutate(Chemicals = rep(labels, 100)) %>% 
  gather(key = PC, value = Loadings, -Chemicals, -seed) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~PC) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "PCA Loadings, Correlated Scores", x = "", y = "Loadings")
```

### FA
```{r, fa6}
fa_loadings_cor %>%  
  filter(seed == 7) %>% 
  mutate(Chemicals = labels) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col(aes(fill = Group)) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        strip.background = element_blank())
```

```{r, fig.width=6}
fa_loadings_cor %>%  
  mutate(Chemicals = rep(labels, 100)) %>% 
  select(seed, Chemicals, V1:V4) %>% 
  gather(key = Factor, value = Loadings, -Chemicals, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>% 
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>% 
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~Factor) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "FA Loadings, Correlated Scores", x = "", y = "Loadings")
```

# Summarize

## Rank

### npBNMF
```{r, npb13}
npb_rank_d <- eh_dist %>% 
  mutate(rank = map(eh, nrow)) %>% 
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Distinct") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

npb_rank_o <- eh_over %>% 
  mutate(rank = map(eh, nrow)) %>%
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Overlapping") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

npb_rank_c <- eh_cor %>% 
  mutate(rank = map(eh, nrow)) %>%
  select(rank = rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Correlated") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)


rbind(npb_rank_d, npb_rank_o, npb_rank_c) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

### PCA
```{r, pca10}
pca_rank_d <- pca_out_dist %>% 
  select(rank) %>% 
  unnest(rank) %>%
  group_by(rank) %>% 
  summarise(n = n()) %>% 
  mutate(Simulation = "Distinct") %>% 
  mutate(Proportion = n/100) %>% 
  select(Simulation, Rank = rank, Proportion)

pca_rank_o <- pca_out_over %>% 
  select(rank) %>% 
  unnest(rank) %>%
  group_by(rank) %>% 
  summarise(n = n()) %>% 
  mutate(Simulation = "Overlapping") %>% 
  mutate(Proportion = n/100) %>% 
  select(Simulation, Rank = rank, Proportion)

pca_rank_c <- pca_out_cor %>% 
  select(rank = rank) %>% 
  unnest(rank) %>%
  group_by(rank) %>% 
  summarise(n = n()) %>% 
  mutate(Simulation = "Correlated") %>% 
  mutate(Proportion = n/100) %>% 
  select(Simulation, Rank = rank, Proportion)

rbind(pca_rank_d, pca_rank_o, pca_rank_c) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

### FA
```{r, fa7}
fa_rank_d <- fa_out_dist %>% 
  mutate(rank = map(loadings, ncol)) %>% 
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Distinct") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

fa_rank_o <- fa_out_over %>% 
  mutate(rank = map(loadings, ncol)) %>%
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Overlapping") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

fa_rank_c <- fa_out_cor %>% 
  mutate(rank = map(loadings, ncol)) %>%
  select(rank = rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Correlated") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

rbind(fa_rank_d, fa_rank_o, fa_rank_c) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

### NMF
```{r, nmf10}
nmf_rank_d <- nmf_out_dist %>% 
  mutate(rank = map(coef, nrow)) %>% 
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Distinct") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

nmf_rank_o <- nmf_out_over %>% 
  mutate(rank = map(coef, nrow)) %>%
  select(rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Overlapping") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

nmf_rank_c <- nmf_out_cor %>% 
  mutate(rank = map(coef, nrow)) %>%
  select(rank = rank) %>%
  unnest(rank) %>%
  group_by(rank) %>%
  summarise(n = n()) %>%
  mutate(Simulation = "Correlated") %>%
  mutate(Proportion = n/100) %>%
  select(Simulation, Rank = rank, Proportion)

rbind(nmf_rank_d, nmf_rank_o, nmf_rank_c) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

## Norms

```{r, func}
add_column <- function(score) {
  if (ncol(score) == 3) {
  score <- cbind(score, four = rep(0, times = nrow(score))) %>% as_tibble(.)
  } else if (ncol(score) == 2) {
  score <- cbind(score, three = rep(0, times = nrow(score)), four = rep(0, times = nrow(score))) %>% as_tibble(.)
  } else {}
  score
}

add_row <- function(pattern) {
  if (nrow(pattern) == 3) {
  pattern <- rbind(pattern, four = rep(0, times = ncol(pattern))) %>% as_tibble(.)
  } else if (nrow(pattern) == 2) {
  pattern <- rbind(pattern, three = rep(0, times = ncol(pattern)), four = rep(0, times = ncol(pattern))) %>% as_tibble(.)
  } else {}
  pattern
}

add_pattern <- function(pattern, true) {
  if (nrow(pattern) == 5) {
  true <- rbind(true, four = rep(0, times = ncol(true))) %>% as_tibble(.)
  } else if (nrow(pattern) == 6) {
  true <- rbind(true, three = rep(0, times = ncol(true)), four = rep(0, times = ncol(true))) %>% as_tibble(.)
  } else {}
  true
}

add_score <- function(score, true) {
  if (ncol(score) == 5) {
  true <- cbind(true, four = rep(0, times = nrow(true))) %>% as_tibble(.)
  } else if (ncol(score) == 6) {
  true <- cbind(true, three = rep(0, times = nrow(true)), four = rep(0, times = nrow(true))) %>% as_tibble(.)
  } else {}
  true
}

standard <- function(row_matrix, column_matrix) {
  sum_row <- apply(row_matrix, 1, function(x) sum(x))
  row_out <-  as_tibble(apply(row_matrix, 1, function(x) x/sum(x))) # Divide patterns by pattern sum to normalize
  col_out <- map2_dfr(as_tibble(column_matrix), sum_row, function(x,y) x*y) # multiply scores by pattern sum
  list(row_out = row_out, col_out = col_out)
}
```

### Unstandardized

#### npBNMF
```{r, npb15}
npb_dist_pred <- npb_scores_ordered_dist %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_dist_load <- npb_scores_ordered_dist %>% 
  #mutate(eh_reordered = map(eh_reordered, add_row)) %>% 
  mutate(patterns = map2(eh_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, eh_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_dist_score <- npb_scores_ordered_dist %>% 
  mutate(ewa_reordered = map(ewa_reordered, add_column)) %>% 
  mutate(scores = map2(ewa_reordered, scores, function(x,y) add_score(x,y))) %>% 
  mutate(norm_scores = map2(scores, ewa_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_over_pred <- npb_scores_ordered_over %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_over_load <- npb_scores_ordered_over %>% 
  mutate(eh_reordered = map(eh_reordered, add_row)) %>% 
  mutate(patterns = map2(eh_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, eh_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_over_score <- npb_scores_ordered_over %>% 
  mutate(ewa_reordered = map(ewa_reordered, add_column)) %>% 
  mutate(scores = map2(ewa_reordered, scores, function(x,y) add_score(x,y))) %>% 
  mutate(norm_scores = map2(scores, ewa_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_cor_pred <- npb_scores_ordered_cor %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_cor_load <- npb_scores_ordered_cor %>% 
  mutate(patterns = map2(eh_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(eh_reordered = map(eh_reordered, add_row)) %>% 
  mutate(patterns = map2(eh_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, eh_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_cor_score <- npb_scores_ordered_cor %>% 
  mutate(ewa_reordered = map(ewa_reordered, add_column)) %>% 
  mutate(scores = map2(ewa_reordered, scores, function(x,y) add_score(x,y))) %>% 
  mutate(norm_scores = map2(scores, ewa_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(npb_dist_pred,
      npb_over_pred,
      npb_cor_pred,
      npb_dist_load,
      npb_over_load,
      npb_cor_load,
      npb_dist_score,
      npb_over_score,
      npb_cor_score) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### PCA
```{r, pca11}
pca_dist_pred <- pca_scores_matched_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_dist_load <- pca_scores_matched_dist %>% 
  mutate(rotations_re = map(rotations_re, add_column)) %>% 
  mutate(norm_loadings = map2(patterns, rotations_re, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_dist_score <- pca_scores_matched_dist %>% 
  mutate(ex_re = map(ex_re, add_column)) %>% 
  mutate(norm_scores = map2(scores, ex_re, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_over_pred <- pca_scores_matched_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_over_load <- pca_scores_matched_over %>% 
  mutate(rotations_re = map(rotations_re, add_column)) %>% 
  mutate(norm_loadings = map2(patterns, rotations_re, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_over_score <- pca_scores_matched_over %>% 
  mutate(ex_re = map(ex_re, add_column)) %>% 
  mutate(norm_scores = map2(scores, ex_re, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_cor_pred <- pca_scores_matched_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_cor_load <- pca_scores_matched_cor %>% 
  mutate(rotations_re = map(rotations_re, add_column)) %>% 
  mutate(norm_loadings = map2(patterns, rotations_re, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_cor_score <- pca_scores_matched_cor %>% 
  mutate(ex_re = map(ex_re, add_column)) %>% 
  mutate(norm_scores = map2(scores, ex_re, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(pca_dist_pred,
      pca_over_pred,
      pca_cor_pred,
      pca_dist_load,
      pca_over_load,
      pca_cor_load,
      pca_dist_score, 
      pca_over_score,
      pca_cor_score) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### FA
```{r, fa8}
fa_dist_pred <- fa_out_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_dist_load <- fa_out_dist %>% 
  mutate(norm_loadings = map2(patterns, loadings, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_dist_score <- fa_out_dist %>% 
  mutate(fa_scores = map(fa_scores, add_column)) %>% 
  mutate(norm_scores = map2(scores, fa_scores, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_over_pred <- fa_out_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_over_load <- fa_out_over %>% 
  mutate(norm_loadings = map2(patterns, loadings, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_over_score <- fa_out_over %>% 
  mutate(norm_scores = map2(scores, fa_scores, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_cor_pred <- fa_out_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_cor_load <- fa_out_cor %>% 
  mutate(norm_loadings = map2(patterns, loadings, 
                              ~norm(as.matrix(.x) - as.matrix(t(.y)), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_cor_score <- fa_out_cor %>% 
  mutate(norm_scores = map2(scores, fa_scores, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(fa_dist_pred,
      fa_over_pred,
      fa_cor_pred,
      fa_dist_load,
      fa_over_load,
      fa_cor_load,
      fa_dist_score, 
      fa_over_score,
      fa_cor_score) %>% 
  mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### NMF
```{r, nmf11}
nmf_dist_pred <- nmf_scores_ordered_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_dist_load <- nmf_scores_ordered_dist %>% 
  mutate(coef_reordered = map(coef_reordered, add_row)) %>% 
  #mutate(patterns = map2(coef_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, coef_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_dist_score <- nmf_scores_ordered_dist %>% 
  mutate(basis_reordered = map(basis_reordered, add_column)) %>% 
  mutate(norm_scores = map2(scores, basis_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_over_pred <- nmf_scores_ordered_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_over_load <- nmf_scores_ordered_over %>% 
  mutate(coef_reordered = map(coef_reordered, add_row)) %>% 
  mutate(patterns = map2(coef_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, coef_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_over_score <- nmf_scores_ordered_over %>% 
  mutate(basis_reordered = map(basis_reordered, add_column)) %>% 
  mutate(scores = map2(basis_reordered, scores, function(x,y) add_score(x,y))) %>% 
  mutate(norm_scores = map2(scores, basis_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_cor_pred <- nmf_scores_ordered_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  pull(norm_all) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Prediction Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_cor_load <- nmf_scores_ordered_cor %>% 
  mutate(coef_reordered = map(coef_reordered, add_row)) %>% 
  mutate(patterns = map2(coef_reordered, patterns, function(x,y) add_pattern(x,y))) %>% 
  mutate(norm_loadings = map2(patterns, coef_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") /
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_loadings) %>% 
  pull(norm_loadings) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_cor_score <- nmf_scores_ordered_cor %>% 
  mutate(basis_reordered = map(basis_reordered, add_column)) %>% 
  mutate(scores = map2(basis_reordered, scores, function(x,y) add_score(x,y))) %>% 
  mutate(norm_scores = map2(scores, basis_reordered, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F")/norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_scores) %>% 
  pull(norm_scores) %>% summary() %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "No") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(nmf_dist_pred,
      nmf_over_pred,
      nmf_cor_pred,
      nmf_dist_load,
      nmf_cor_load,
      nmf_over_load,
      nmf_dist_score,      
      nmf_over_score,
      nmf_cor_score) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```


### Prediction Error

```{r}
npb_error_dist <- npb_scores_ordered_dist %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "npBNMF",
                         Simulation = "Distinct") %>% 
  select(Method, Simulation, Error = norm_all)

npb_error_over <- npb_scores_ordered_over %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "npBNMF",
         Simulation = "Overlapping") %>% 
  select(Method, Simulation, Error = norm_all)

npb_error_cor <- npb_scores_ordered_cor %>%
  mutate(pred = map2(ewa_reordered, eh_reordered, function(x,y) as.matrix(x) %*% as.matrix(y))) %>% 
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "npBNMF",
         Simulation = "Correlated") %>% 
  select(Method, Simulation, Error = norm_all)

npb_error <- rbind(npb_error_dist, npb_error_over, npb_error_cor)
```

```{r}
pca_error_dist <- pca_scores_matched_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "PCA",
         Simulation = "Distinct") %>% 
  select(Method, Simulation, Error = norm_all)

pca_error_over <- pca_scores_matched_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "PCA",
         Simulation = "Overlapping") %>% 
  select(Method, Simulation, Error = norm_all)

pca_error_cor <- pca_scores_matched_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "PCA",
         Simulation = "Correlated") %>% 
  select(Method, Simulation, Error = norm_all)

pca_error <- rbind(pca_error_dist, pca_error_over, pca_error_cor)
```

```{r}
nmf_error_dist <- nmf_scores_matched_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "NMF",
         Simulation = "Distinct") %>% 
  select(Method, Simulation, Error = norm_all)

nmf_error_over <- nmf_scores_matched_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "NMF",
         Simulation = "Overlapping") %>% 
  select(Method, Simulation, Error = norm_all)

nmf_error_cor <- nmf_scores_matched_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "NMF",
         Simulation = "Correlated") %>% 
  select(Method, Simulation, Error = norm_all)

nmf_error <- rbind(nmf_error_dist, nmf_error_over, nmf_error_cor)
```

```{r}
fa_error_dist <- fa_out_dist %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "FA",
         Simulation = "Distinct") %>% 
  select(Method, Simulation, Error = norm_all)

fa_error_over <- fa_out_over %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "FA",
         Simulation = "Overlapping") %>% 
  select(Method, Simulation, Error = norm_all)

fa_error_cor <- fa_out_cor %>%
  mutate(norm_all = map2(sim, pred, function(x, y) {norm(as.matrix(x) - as.matrix(y), "F")/norm(as.matrix(x), "F")})) %>% 
  unnest(norm_all) %>% 
  select(norm_all) %>%
  mutate(Method = "FA",
         Simulation = "Correlated") %>% 
  select(Method, Simulation, Error = norm_all)

fa_error <- rbind(fa_error_dist, fa_error_over, fa_error_cor)
```

```{r}
rbind(npb_error, pca_error, nmf_error, fa_error) %>% 
  group_by(Method, Simulation) %>% 
  summarise(mean = mean(Error))
```

```{r, fig.height=4}
rbind(npb_error, pca_error, nmf_error, fa_error) %>% 
  ggplot(aes(x = Method, y = Error, group = Method)) + geom_boxplot() +
  facet_grid(.~Simulation) +
  theme_bw()

rbind(npb_error, pca_error, nmf_error, fa_error) %>% 
  ggplot(aes(x = Method, y = Error)) + geom_jitter(aes(color= Method), alpha = 0.5, size = 0.5, height = 0, width = 0.25) +
  geom_boxplot(aes(x = Method), alpha = 0.25, width = .3, outlier.shape = NA) +
  facet_wrap(.~Simulation) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "", x = "", y = "Relative Prediction Error") #+
  #scale_color_brewer(palette="Set1")
```

### Standardized

#### npBNMF
```{r, npb14}
sd_npb_dist_out <- npb_scores_ordered_dist %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_eh       = map2(eh_reordered, ewa_reordered,function(x,y) standard(x,y)[[1]]),
         sd_ewa      = map2(eh_reordered, ewa_reordered, function(x,y) standard(x,y)[[2]])) %>% 
  mutate(sd_patterns = map2(sd_eh, sd_patterns, add_score),
         sd_scores   = map2(sd_ewa, sd_scores, add_score)) %>%
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)

sd_npb_over_out <- npb_scores_ordered_over %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_eh       = map2(eh_reordered, ewa_reordered,function(x,y) standard(x,y)[[1]]),
         sd_ewa      = map2(eh_reordered, ewa_reordered, function(x,y) standard(x,y)[[2]])) %>% 
  mutate(sd_patterns = map2(sd_eh, sd_patterns, add_score),
         sd_scores   = map2(sd_ewa, sd_scores, add_score)) %>%
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)

sd_npb_cor_out <- npb_scores_ordered_cor %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_eh       = map2(eh_reordered, ewa_reordered,function(x,y) standard(x,y)[[1]]),
         sd_ewa      = map2(eh_reordered, ewa_reordered, function(x,y) standard(x,y)[[2]])) %>% 
  mutate(sd_patterns = map2(sd_eh, sd_patterns, add_score),
         sd_scores   = map2(sd_ewa, sd_scores, add_score)) %>%
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)

npb_dist_norm <- sd_npb_dist_out %>%
mutate(norm_eh = map2(sd_patterns, sd_eh, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)

npb_over_norm <- sd_npb_over_out %>%   
mutate(norm_eh = map2(sd_patterns, sd_eh, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)
  
npb_cor_norm <- sd_npb_cor_out %>%   
mutate(norm_eh = map2(sd_patterns, sd_eh, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)

npb_dist_norm_ewa <- sd_npb_dist_out %>% 
mutate(norm_ewa = map2(sd_scores, sd_ewa, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_ewa) %>% 
  pull(norm_ewa)

npb_over_norm_ewa <- sd_npb_over_out %>%   
mutate(norm_ewa = map2(sd_scores, sd_ewa, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_ewa) %>% 
  pull(norm_ewa)

npb_cor_norm_ewa <- sd_npb_cor_out %>%   
mutate(norm_ewa = map2(sd_scores, sd_ewa, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_ewa) %>% 
  pull(norm_ewa)

npb_over_load_s <- summary(npb_over_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_cor_load_s <- summary(npb_cor_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_dist_load_s <- summary(npb_dist_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_over_score_s <- summary(npb_over_norm_ewa) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_cor_score_s <- summary(npb_cor_norm_ewa) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

npb_dist_score_s <- summary(npb_dist_norm_ewa) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(npb_dist_load_s,
      npb_over_load_s,
      npb_cor_load_s,
      npb_dist_score_s, 
      npb_over_score_s,
      npb_cor_score_s) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### PCA

**Ask about this**   

```{r, pca12}
pca_sd_dist_out <- pca_scores_matched_dist %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]), # Normalize and Standardize first
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis    = map2(rotations_re, ex_re,function(x,y) standard(t(x),y)[[2]]),
         sd_coef     = map2(rotations_re, ex_re, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_pattern),             # then add extra row/column for norm compatibility
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>%
  select(-rotations_re, -ex_re, -scores, -patterns)

pca_dist_norm <- pca_sd_dist_out %>% 
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

pca_sd_over_out <- pca_scores_matched_over %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis    = map2(rotations_re, ex_re,function(x,y) standard(t(x),y)[[2]]),
         sd_coef     = map2(rotations_re, ex_re, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_pattern),
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>%
  select(-rotations_re, -ex_re, -scores, -patterns)

pca_over_norm <- pca_sd_over_out %>%   
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

pca_sd_cor_out <- pca_scores_matched_cor %>%
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis    = map2(rotations_re, ex_re,function(x,y) standard(t(x),y)[[2]]),
         sd_coef     = map2(rotations_re, ex_re, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_pattern),
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>%
  select(-rotations_re, -ex_re, -scores, -patterns)
  
pca_cor_norm <- pca_sd_cor_out %>%   
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

pca_dist_norm_basis <- pca_sd_dist_out %>% 
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

pca_over_norm_basis <- pca_sd_over_out %>%   
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

pca_cor_norm_basis <- pca_sd_cor_out %>%   
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

pca_over_load_s <- summary(pca_over_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_cor_load_s <- summary(pca_cor_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_dist_load_s <- summary(pca_dist_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_over_score_s <- summary(pca_over_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_cor_score_s <- summary(pca_cor_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

pca_dist_score_s <- summary(pca_dist_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(pca_dist_load_s,
      pca_over_load_s,
      pca_cor_load_s,
      pca_dist_score_s, 
      pca_over_score_s,
      pca_cor_score_s) %>% mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### FA
```{r, fa9}
fa_sd_dist_out <- fa_out_dist %>% 
  select(-sim, -noise, -pred, -chem, -fa_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_fa_score       = map2(loadings, fa_scores,function(x,y) standard(t(x),y)[[2]]),
         sd_loading     = map2(loadings, fa_scores, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_loading, sd_patterns, add_pattern),
         sd_scores   = map2(sd_fa_score, sd_scores, add_score),
         sd_loading     = map(sd_loading, add_row),
         sd_fa_score    = map(sd_fa_score, add_column)) %>%
  select(-scores, -patterns, -loadings, -fa_scores)

fa_dist_norm <- fa_sd_dist_out %>% 
mutate(norm_eh = map2(sd_patterns, sd_loading, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)

fa_sd_over_out <- fa_out_over %>% 
  select(-sim, -noise, -pred, -chem, -fa_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_fa_score       = map2(loadings, fa_scores,function(x,y) standard(t(x),y)[[2]]),
         sd_loading     = map2(loadings, fa_scores, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_loading, sd_patterns, add_pattern),
         sd_scores   = map2(sd_fa_score, sd_scores, add_score),
         sd_loading     = map(sd_loading, add_row),
         sd_fa_score    = map(sd_fa_score, add_column)) %>%
  select(-scores, -patterns, -loadings, -fa_scores)

fa_over_norm <- fa_sd_over_out %>%   
mutate(norm_eh = map2(sd_patterns, sd_loading, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)

fa_sd_cor_out <- fa_out_cor %>% 
  select(-sim, -noise, -pred, -chem, -fa_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_fa_score       = map2(loadings, fa_scores,function(x,y) standard(t(x),y)[[2]]),
         sd_loading     = map2(loadings, fa_scores, function(x,y) standard(t(x),y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_loading, sd_patterns, add_pattern),
         sd_scores   = map2(sd_fa_score, sd_scores, add_score),
         sd_loading     = map(sd_loading, add_row),
         sd_fa_score    = map(sd_fa_score, add_column)) %>%
  select(-scores, -patterns, -loadings, -fa_scores)
  
fa_cor_norm <- fa_sd_cor_out %>%   
mutate(norm_eh = map2(sd_patterns, sd_loading, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_eh) %>% 
  pull(norm_eh)

dist_norm_fa_score <- fa_sd_dist_out %>% 
mutate(norm_fa_score = map2(sd_scores, sd_fa_score, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_fa_score) %>% 
  pull(norm_fa_score)

over_norm_fa_score <- fa_sd_over_out %>%   
mutate(norm_fa_score = map2(sd_scores, sd_fa_score, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_fa_score) %>% 
  pull(norm_fa_score)

cor_norm_fa_score <- fa_sd_cor_out %>%   
mutate(norm_fa_score = map2(sd_scores, sd_fa_score, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_fa_score) %>% 
  pull(norm_fa_score)

fa_over_load_s <- summary(fa_over_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_cor_load_s <- summary(fa_cor_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_dist_load_s <- summary(fa_dist_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Loadings",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_over_score_s <- summary(over_norm_fa_score) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_cor_score_s <- summary(cor_norm_fa_score) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

fa_dist_score_s <- summary(dist_norm_fa_score) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(fa_dist_load_s,
      fa_over_load_s,
      fa_cor_load_s,
      fa_dist_score_s, 
      fa_over_score_s,
      fa_cor_score_s) %>% 
  mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

#### NMF
```{r, nmf12}
nmf_sd_dist_out <- nmf_scores_ordered_dist %>% 
  select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis       = map2(coef_reordered, basis_reordered,function(x,y) standard(x,y)[[2]]),
         sd_coef     = map2(coef_reordered, basis_reordered, function(x,y) standard(x,y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_pattern),
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>%
  select(-coef_reordered, -basis_reordered, -scores, -patterns)

nmf_sd_dist_norm <- nmf_sd_dist_out %>% 
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

nmf_sd_over_out <- nmf_scores_ordered_over %>% 
  select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis    = map2(coef_reordered, basis_reordered,function(x,y) standard(x,y)[[2]]),
         sd_coef     = map2(coef_reordered, basis_reordered, function(x,y) standard(x,y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_score),
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>% 
  select(-coef_reordered, -basis_reordered, -scores, -patterns)

nmf_sd_over_norm <- nmf_sd_over_out %>%   
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

nmf_sd_cor_out <- nmf_scores_ordered_cor %>%
  select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map2(patterns, scores, function(x,y) standard(x,y)[[1]]),
         sd_scores   = map2(patterns, scores, function(x,y) standard(x,y)[[2]]),
         sd_basis    = map2(coef_reordered, basis_reordered,function(x,y) standard(x,y)[[2]]),
         sd_coef     = map2(coef_reordered, basis_reordered, function(x,y) standard(x,y)[[1]])) %>% 
  mutate(sd_patterns = map2(sd_coef, sd_patterns, add_score),
         sd_scores   = map2(sd_basis, sd_scores, add_score),
         sd_coef     = map(sd_coef, add_column),
         sd_basis    = map(sd_basis, add_column)) %>%
  select(-coef_reordered, -basis_reordered, -scores, -patterns)
  
nmf_sd_cor_norm <- nmf_sd_cor_out %>%   
mutate(norm_coef = map2(sd_patterns, sd_coef, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_coef) %>% 
  pull(norm_coef)

nmf_sd_dist_norm_basis <- nmf_sd_dist_out %>% 
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

nmf_sd_over_norm_basis <- nmf_sd_over_out %>%   
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

nmf_sd_cor_norm_basis <- nmf_sd_cor_out %>%   
mutate(norm_basis = map2(sd_scores, sd_basis, 
                              ~norm(as.matrix(.x) - as.matrix(.y), "F") / 
                                norm(as.matrix(.x), "F"))) %>% 
  unnest(norm_basis) %>% 
  pull(norm_basis)

nmf_sd_over_load_s <- summary(nmf_sd_over_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_sd_cor_load_s <- summary(nmf_sd_cor_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_sd_dist_load_s <- summary(nmf_sd_dist_norm) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Loading Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_sd_over_score_s <- summary(nmf_sd_over_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Overlapping",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_sd_cor_score_s <- summary(nmf_sd_cor_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Correlated",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

nmf_sd_dist_score_s <- summary(nmf_sd_dist_norm_basis) %>% as.matrix() %>% t() %>% 
  as_tibble() %>% mutate(Norm = "Relative Score Error",
                         Simulation = "Distinct",
                         Standardized = "Yes") %>% 
  select(Norm, Simulation, Standardized, everything())

rbind(nmf_sd_dist_load_s,
      nmf_sd_over_load_s,
      nmf_sd_cor_load_s,
      nmf_sd_dist_score_s, 
      nmf_sd_over_score_s,
      nmf_sd_cor_score_s) %>% 
  mutate_if(is.numeric, round, 2) %>% knitr::kable()
```

## Standardize Plots

```{r}
standard_plot <- function(row_matrix) {
  sum_row <- apply(row_matrix, 2, function(x) sum(x))
  row_out <-  as_tibble(apply(row_matrix, 2, function(x) x/sum(x))) # Divide patterns by CHEMICAL sum to normalize
  row_out
}
```

### npBNMF
```{r, npb80}
sd_npb_1 <- npb_scores_ordered_dist %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_eh       = map(eh_reordered,standard_plot)) %>% 
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)

sd_npb_2 <- npb_scores_ordered_over %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_eh       = map(eh_reordered, standard_plot)) %>% 
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)

sd_npb_3 <- npb_scores_ordered_cor %>% 
  select(-eh, -ewa, -sim, -noise) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_eh       = map(eh_reordered,standard_plot)) %>% 
  select(-eh_reordered, -ewa_reordered, -scores, -patterns)
```

```{r, fig.width=6}
#need tibble to unnest
dist_patterns <- sd_npb_1 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_eh) %>% 
  unnest(cols = c(sd_patterns))

dist_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -seed, -pattern1) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Distinct Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=8}
dist_nbp <- sd_npb_1 %>% 
  mutate(sd_eh = map(sd_eh, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_eh))

dist_nbp %>%
group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                                                     ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                                                            ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                                                   "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "npBNMF Loadings, Distinct Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
over_patterns <- sd_npb_2 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_eh) %>% 
  unnest(cols = c(sd_patterns))

over_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Overlapping Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=8}
over_nbp <- sd_npb_2 %>% 
  mutate(sd_eh = map(sd_eh, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_eh))

over_nbp %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "npBNMF Loadings, Overlapping Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
cor_patterns <- sd_npb_3 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_eh) %>% 
  unnest(cols = c(sd_patterns))

cor_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Corr Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
cor_nbp <- sd_npb_3 %>% 
  mutate(sd_eh = map(sd_eh, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_eh))

cor_nbp %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = Loadings)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "npBNMF Loadings, Correlated Scores", x = "", y = "Normalized Loadings")
```

### NMF

```{r, nmf120}
nmf_sd_1 <- nmf_scores_ordered_dist %>% 
  select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_coef     = map(coef_reordered, standard_plot)) %>% 
  select(-coef_reordered, -basis_reordered, -scores, -patterns)

nmf_sd_2 <- nmf_scores_ordered_over %>% 
    select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_coef     = map(coef_reordered, standard_plot)) %>% 
  select(-coef_reordered, -basis_reordered, -scores, -patterns)

nmf_sd_3 <- nmf_scores_ordered_cor %>%
    select(-coef, -basis, -pred, -sim, -noise, -nmf_out) %>% 
  mutate(sd_patterns = map(patterns, standard_plot),
         sd_coef     = map(coef_reordered, standard_plot)) %>% 
  select(-coef_reordered, -basis_reordered, -scores, -patterns)
```

```{r, fig.width=6}
dist_patterns <- nmf_sd_1 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_coef) %>% 
  unnest(cols = c(sd_patterns))

dist_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Distinct Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
dist_nmf <- nmf_sd_1 %>% 
  mutate(sd_coef = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_coef))

dist_nmf %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "NMF Loadings, Distinct Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
over_patterns <- nmf_sd_2 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_coef) %>% 
  unnest(cols = c(sd_patterns))

over_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Overlapping Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=8}
over_nmf <- nmf_sd_2 %>% 
  mutate(sd_coef = map(sd_coef, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_coef))

over_nmf %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "NMF Loadings, Overlapping Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=6}
cor_patterns <- nmf_sd_3 %>% 
  mutate(sd_patterns = map(sd_patterns, function(x) as_tibble(x))) %>% 
  select(-sd_coef) %>% 
  unnest(cols = c(sd_patterns))

cor_patterns %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "True Corr Patterns", x = "", y = "Normalized Loadings")
```

```{r, fig.width=8}
cor_nmf <- nmf_sd_3 %>% 
  mutate(sd_coef = map(sd_coef, function(x) as_tibble(x))) %>% 
  select(-sd_patterns) %>% 
  unnest(cols = c(sd_coef))

cor_nmf %>%
  group_by(seed) %>% 
  mutate(pattern1=1:n()) %>% 
  select(seed, pattern1, everything()) %>% 
  gather(key = Chemicals, value = coefs, -pattern1, -seed) %>%
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  mutate(Group = ifelse(str_detect(Chemicals, "BDE"), "PBDEs",
                        ifelse(str_detect(Chemicals, "^M"), "Phthalates",
                               ifelse(str_detect(Chemicals, "pcb"), "PCBs",
                                      "Phenols")))) %>%
  ggplot(aes(x = Group, y = coefs)) + geom_jitter(aes(color = Group), alpha = 0.5, size = 0.05, height = 0) +
  geom_boxplot(aes(x = Group), alpha = 0.25, width = .4, outlier.shape = NA) +
  facet_wrap(.~pattern1) + theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank()) + labs(title= "NMF Loadings, Correlated Scores", x = "", y = "Normalized Loadings")
```

## Symmetric Subspace Distance

```{r}
### Symmetric Subspace Distance
symm_subspace_dist <- function(U, V) {
  
  if (nrow(U) != nrow(V)) stop("Matrices must have same number of participants (rows).")
  
  qrU <- qr.Q(qr(U))
  qrV <- qr.Q(qr(V))
  
  m <- ncol(U)
  n <- ncol(V)
  
  dUV <- sqrt( max(m,n) - sum((t(qrU) %*% qrV)^2) )
  
  ratio <- dUV/sqrt( max(m,n))
  
  list(symm_subspace_dist = dUV, Similarity = ratio)

  }
```

```{r}
npb_scores_ordered_dist %>% 
  mutate(number_patterns = map(eh_reordered, nrow),
         symm_dist = map2(scores, ewa_reordered, function(x,z) symm_subspace_dist(x,z)[[1]]),
         symm_ratio = map2(scores, ewa_reordered, function(x,z) symm_subspace_dist(x,z)[[2]]),) %>% 
  select(seed, number_patterns, symm_dist, symm_ratio) %>% 
  unnest(cols = c(number_patterns, symm_dist, symm_ratio)) %>% select(symm_ratio) %>%
  ggplot(aes(x = symm_ratio)) + geom_histogram(bins = 100) +
  theme_minimal() +
  labs(y = "Count", x = "Symmetric Subspace Distance Ratio")
```