---
title: "MN Data"
author: "Lizzy Gibson"
date: "2/25/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
library(gplots)
library(GGally)
library(janitor)
```

## MN Data

```{r}
# PHT and phenols specific gravity adj
edc_cc <- 
  mn_edc %>% 
  dplyr::select(grep("sg_adj", colnames(.))) %>% 
  drop_na() %>% 
  clean_names() %>% 
  dplyr::rename_all(function(x) str_replace(x, "_sg_adj", "")) %>% 
  dplyr::rename_all(toupper)
  
edc_std <- apply(edc_cc, 2, function(x) x/sd(x)) %>% as_tibble()

cc_ids <- mn_edc %>% dplyr::select(sid, grep("sg_adj", colnames(.))) %>% drop_na() %>% 
  dplyr::select(1)

edc_cc %>% 
  pivot_longer(1:17) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 100) +
facet_wrap(~name, scales = "free")

apply(edc_cc, 2, mean)
apply(edc_cc, 2, sd)

summary(apply(edc_cc, 2, mean))
summary(apply(edc_cc, 2, sd))
```

```{r}
edc_re <- edc_cc %>% dplyr::select(1:11, 13, 16:17, 12, 14:15)

#pdf("Figures/mn_edc_corr.pdf", width = 7, height = 5)
ggcorr(edc_re, method = c("pairwise", "spearman"),
       hjust = 0.85, size = 5, color = "grey50",
       layout.exp = 3,
       label = TRUE, label_size = 2, label_round = 2, label_alpha = TRUE
       ) + 
  theme_minimal()
#dev.off()

prcomp(edc_std)$sdev
sum( prcomp(edc_std)$sdev[1:11]/sum(prcomp(edc_std)$sdev) )
# 11 > 80% var
# no obvious elbow

plot(prcomp(edc_std))

as_tibble(prcomp(edc_std)$rotation) %>% 
  mutate(edc = colnames(edc_cc)) %>% 
  pivot_longer(1:17) %>% 
  mutate(name = as.factor(name)) %>% 
  filter(name %in% c("PC1", "PC2", "PC3", "PC4", "PC5", "PC6")) %>% 
  ggplot(aes(x = edc, y = value)) + 
  geom_col() +
  facet_wrap(.~ name)
```

```{r}
#write_csv(edc_cc, "./Data/isee_2020_dat.csv")
#write_csv(edc_std, "./Data/isee_2020_dat_std.csv")
```

## NMF

```{r}
nmf_1 <- nmf(edc_std, rank = 1, nrun = 10, method = "lee")
nmf_2 <- nmf(edc_std, rank = 2, nrun = 10, method = "lee")
nmf_3 <- nmf(edc_std, rank = 3, nrun = 10, method = "lee")
nmf_4 <- nmf(edc_std, rank = 4, nrun = 10, method = "lee")
nmf_5 <- nmf(edc_std, rank = 5, nrun = 10, method = "lee")
nmf_6 <- nmf(edc_std, rank = 6, nrun = 10, method = "lee")
# Factory fresh default value is ‘brunet’ == KL

  bic_1 <- sum((edc_std - (basis(nmf_1)%*%coef(nmf_1)))^2) + 
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 1 * log(nrow(edc_std) * ncol(edc_std))
  bic_2 <- sum((edc_std - (basis(nmf_2)%*%coef(nmf_2)))^2) + 
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 2 * log(nrow(edc_std) * ncol(edc_std))
  bic_3 <- sum((edc_std - (basis(nmf_3)%*%coef(nmf_3)))^2) + 
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 3 * log(nrow(edc_std) * ncol(edc_std))
  bic_4 <- sum((edc_std - (basis(nmf_4)%*%coef(nmf_4)))^2) + 
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 4 * log(nrow(edc_std) * ncol(edc_std))
  bic_5 <- sum((edc_std - (basis(nmf_5)%*%coef(nmf_5)))^2) +  
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 5 * log(nrow(edc_std) * ncol(edc_std))
  bic_6 <- sum((edc_std - (basis(nmf_6)%*%coef(nmf_6)))^2) +  
    (1/2)*(nrow(edc_std) + ncol(edc_std)) * 5 * log(nrow(edc_std) * ncol(edc_std))
  
bic_1
bic_2
bic_3
bic_4
bic_5
bic_6
  
coef(nmf_1) %>% 
  as_tibble() %>% 
  mutate(pattern = 1:nrow(.)) %>% 
  pivot_longer(1:17) %>% 
  mutate(name = as.factor(name)) %>% 
  ggplot(aes(x = name, y = value)) + 
  geom_col() +
  facet_wrap(.~ pattern) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

