---
title: "Simulations with new variance"
author: "Lizzy Gibson"
date: "7/24/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(MNdata) # my data
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
```

## 1: Distinct Patterns

### Simulate Patterns

Generate 4 non-negative vectors of length 50 “by hand” — vectors should be overlapping a bit, and at this stage don’t have to look too much like pollution. just make 20 (of 50) elements 1 and the rest 0.

Pattern matrix is 4*50, patterns by chemicals.

```{r}
## Construct a matrix for 4 TRUE exposure patterns
labels <-  c("pcb28", "pcb66", "pcb74", "pcb99", "pcb105", "pcb118", "pcb138_158", "pcb146", "pcb153", "pcb156", "pcb167",
          "pcb170", "pcb178", "pcb183", "pcb187", "pcb180", "pcb189", "pcb194", "pcb196_203", "pcb199", "pcb206", "pcb209",
          "BDE17", "BDE28", "BDE47", "BDE66", "BDE85", "BDE99", "BDE100", "BDE153", "BDE154", "BDE183", "BDE209", "MECPP",
          "MEHHP", "MEOHP", "MCPP", "MIBP", "MBP", "MBZP", "MEP", "MEHP", "dcp_24", "dcp_25", "b_pb", "bp_3", "m_pb",
          "p_pb", "tcs", "bpa")

create_patterns_dist <- function (seed) {
  set.seed(seed)
  patterns_dist <- rbind(c(runif(22, 1, 2), rep(0, 11), rep(0, 17)),
                       c(rep(0, 22), runif(11, 1, 2), rep(0, 17)),
                       c(rep(0, 33), runif(9, 1, 2), rep(0, 8)),
                       c(rep(0, 33), rep(0, 9), runif(8, 1, 2)))
  colnames(patterns_dist) <- labels
  patterns_dist
}

patterns_dist_iter <- tibble(seed = 1:100) %>% 
 mutate(patterns = map(seed, ~create_patterns_dist(seed = .x)))
```

### Simulate Scores

```{r}
create_scores_dist <- function (seed) {
  scores_dist <- matrix(nrow = 1000, ncol = 4)
  set.seed(seed)
  scores_dist <- exp(mvrnorm(n = 1000, mu = rep(1, 4), 
                          Sigma = diag(rep(1, 4)))) # Independent log normal dist
  scores_dist
}

scores_dist_iter <- tibble(seed = 1:100) %>% 
 mutate(scores = map(seed, ~create_scores_dist(seed = .x)))
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_dist0 <- full_join(scores_dist_iter, patterns_dist_iter, by = "seed")

sim_dist0 <- sim_dist0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`))
```

### Simulate Noise

```{r}
add_noise <- function (seed, chem) {
  noise <- list(mean=0, sd=1)
  set.seed(seed)
  chem_dist <- pmax(chem + rmatrix(1000, 50, dist=rnorm, mean=noise$mean, sd=noise$sd), 0)	
  chem_dist
}

sim_dist <- sim_dist0 %>% 
 mutate(sim = map2(seed, chem, add_noise),
        #sim = map(sim, function(x) scale(x, center = FALSE, scale = apply(x, 2, function(x) sd(x)*.1))),
        sim = map(sim, function(x) apply(x, 2, function(x) 10*(x/sd(x)))))

apply(sim_dist[1,5][[1]][[1]], 2, var)
```

### Save

```{r}
sim_dist_100 <- sim_dist %>% rename(true_patterns = patterns, true_scores = scores) %>% dplyr::select(-chem)
         
save(sim_dist_100, file = "./R/Sims/Iterate/sim_dist_100.RDA")

for (i in 1:100) {
  write_csv(as_tibble(sim_dist_100[i,4][[1]][[1]]), paste0("./R/Sims/Iterate/sim_dist_100_", i, ".csv"))
}
```

## 2: Correlated Patterns

### Simulate Patterns

```{r}
## Construct a matrix for 4 TRUE exposure patterns
create_patterns_cor <- function (seed) {
  set.seed(seed)
  patterns_cor <- rbind(c(runif(22, 1, 2),   runif(11, 0.5, 1), rep(0, 17)),
                         c(rep(0, 22),        runif(11, 1, 2),   runif(9, 0.5, 1),  rep(0, 8)),
                         c(rep(0, 33),                           runif(9, 1, 2),    runif(8, 0.5, 1)),
                         c(runif(22, 0.5, 1), rep(0, 11),        rep(0, 9),         runif(8, 1, 2)))
  
  colnames(patterns_cor) <- labels
  patterns_cor
}

patterns_cor_iter <- tibble(seed = 1:100) %>% 
 mutate(patterns = map(seed, create_patterns_cor))
```

### Simulate Scores

```{r}
create_scores_cor <- function (seed) {
  scores_cor <- matrix(nrow = 1000, ncol = 4)
  cov <- matrix( c(1,    0.25, 0.15, 0.15,
                  0.25, 1,    0.15, 0.15,
                  0.15, 0.15, 1,    0.25,
                  0.15, 0.15, 0.25, 1), nrow = 4)
  
  set.seed(seed)
  scores_cor <- exp(mvrnorm(n = 1000, mu = rep(1, 4), 
                          Sigma = cov)) # dists are kind of DEPENDENT
  }

scores_cor_iter <- tibble(seed = 1:100) %>% 
 mutate(scores = map(seed, create_scores_cor))
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_cor0 <- full_join(scores_cor_iter, patterns_cor_iter, by = "seed")

sim_cor0 <- sim_cor0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`))
```

### Simulate Noise

```{r}
sim_cor <- sim_cor0 %>% 
 mutate(sim = map2(seed, chem, add_noise),
        sim = map(sim, function(x) apply(x, 2, function(x) 10*(x/sd(x)))))
```  

### Save

```{r}
sim_cor_100  <- sim_cor %>% rename(true_patterns = patterns, true_scores = scores) %>% dplyr::select(-chem)
save(sim_cor_100, file = "./R/Sims/Iterate/sim_cor_100.RDA")

for (i in 1:100) {
  write_csv(as_tibble(sim_cor_100[i,4][[1]][[1]]), paste0("./R/Sims/Iterate/sim_cor_100_", i, ".csv"))
}
```

## 3: Overlapping Patterns

### Simulate Patterns

Use correlated patterns.

### Simulate Scores

Use distinct scores.

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_over0 <- full_join(scores_dist_iter, patterns_cor_iter, by = "seed")

sim_over0 <- sim_over0 %>% 
  mutate(chem = map2(scores, patterns, `%*%`))
```

### Simulate Noise

```{r}
sim_over <- sim_over0 %>% 
 mutate(sim = map2(seed, chem, add_noise),
        sim = map(sim, function(x) apply(x, 2, function(x) 10*(x/sd(x)))))
```

### Save

```{r} 
sim_over_100 <- sim_over %>% rename(true_patterns = patterns, true_scores = scores) %>% dplyr::select(-chem)
save(sim_over_100, file = "./R/Sims/Iterate/sim_over_100.RDA")

for (i in 1:100) {
  write_csv(as_tibble(sim_over_100[i,4][[1]][[1]]), paste0("./R/Sims/Iterate/sim_over_100_", i, ".csv"))
}
```

