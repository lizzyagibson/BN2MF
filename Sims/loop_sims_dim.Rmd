---
title: "Loop size, rows, columns, patterns"
author: "Lizzy Gibson"
date: "3/5/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
library(MCMCpack) # for dirichlet
```

## 0: Loop This

```{r}
patterns <- c(1, 4, 10)
participants <- c(200, 1000, 10000)
chemicals <- c(20, 50, 100)
seed <- c(1:100)

loop_scores <- expand_grid(seed, patterns, participants, chemicals)
loop_patterns <- expand_grid(seed, participants, chemicals)
```

## 1: Distinct Scores

### Simulate Scores

* Generate non-negative scores
* 1,000 individuals with scores on each of 4 patterns
* Individual distributions are independent
* Patterns (columns) are standardized to stdev = 1
   * Not mean-centered

```{r}
create_scores_dist <- function (seed, participants, patterns) {
  scores_dist <- matrix(nrow = participants, ncol = patterns)
  set.seed(seed)
  scores_dist <- exp(mvrnorm(n = participants, mu = rep(1, patterns), 
                          Sigma = diag(rep(1, patterns)))) # independent log normal dist

  scores_dist
  }

scores_iter <- loop_scores %>% 
 mutate(true_scores = pmap(list(seed, participants, patterns), create_scores_dist))
```

### Simulate Noise

* Add noise

```{r}
# noise = 1000x50
add_noise <- function (seed, chem_matrix) {
  n = nrow(chem_matrix)
  p = ncol(chem_matrix)
  noise <- list(sd = rep(1, p))
  set.seed(seed)
  chem_dist <- pmax(chem_matrix + mvrnorm(n = n, mu = rep(0, p), 
                                             Sigma = diag(noise$sd)), 0)	
  chem_dist
}
```

## 2: Overlapping Patterns

### Simulate Patterns

```{r}
## Construct a matrix for 1,4,10 TRUE exposure patterns
create_1pattern <- function (seed, chemicals) {
  set.seed(seed)
  patterns <- matrix(c(runif(chemicals/2, 1, 2), rep(0, chemicals/2)), nrow = 1)
  patterns
}

create_4patterns <- function (seed, chemicals) {
  set.seed(seed)
  group_1 <- chemicals %/% 4
  group_2 <- (chemicals - 2*group_1)/2
  
  patterns <-
    rbind(c(runif(group_1, 1, 2),   runif(group_1, 0.5, 1), rep(0, 2*group_2)),
          c(rep(0, group_1),        runif(group_1, 1, 2), runif(group_2, 0.5, 1), rep(0, group_2)),
          c(rep(0, 2*group_1),                            runif(group_2, 1, 2),   runif(group_2, 0.5, 1)),
          c(runif(group_1, 0.5, 1), rep(0, group_1 + group_2), runif(group_2, 1, 2)))
  
  patterns
}

create_10patterns <- function (seed, chemicals) {
  set.seed(seed)
  group <- chemicals / 10
  
  patterns <-
    rbind(c(runif(group, 1, 2),   runif(group, 0.5, 1), rep(0, 8*group)),
          c(rep(0, group),        runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*7)),
          c(rep(0, group*2),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*6)),
          c(rep(0, group*3),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*5)),
          c(rep(0, group*4),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*4)),
          c(rep(0, group*5),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*3)),
          c(rep(0, group*6),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group*2)),
          c(rep(0, group*7),      runif(group, 1, 2), runif(group, 0.5, 1),   rep(0, group)),
          c(rep(0, group*8),      runif(group, 1, 2), runif(group, 0.5, 1)),
          c(runif(group, 0.5, 1), rep(0, 8*group), runif(group, 1, 2)))
          
  patterns
}

patterns_iter <- loop_patterns %>% 
 mutate(four = map2(seed, chemicals, create_4patterns),
        one  = map2(seed, chemicals, create_1pattern),
        ten  = map2(seed, chemicals, create_10patterns)) %>% 
  pivot_longer(c(four, one, ten),
               values_to = "true_patterns",
               names_to = "patterns") %>% 
  mutate(patterns = case_when(patterns == "four" ~ 4,
                              patterns == "one" ~ 1,
                              patterns == "ten" ~ 10))
  
```

```{r}
patterns_iter[3,5][[1]][[1]] %>% as_tibble() %>% 
  mutate(Pattern = 1:base::nrow(.)) %>% 
  dplyr::select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col() +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45),
        strip.background = element_blank()) +
  labs(title = "Overlapping Patterns")
```

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_over <- 
  left_join(patterns_iter, scores_iter) %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))

chem <- sim_over$chem[[1]]

# St dev of chemicals
apply(chem, 2, mean)
apply(chem, 2, sd)
```

### Simulate Noise

```{r}
sim_over <- sim_over %>% 
 mutate(sim = map2(seed, chem, add_noise))

# St dev of chemicals
sm <- sim_over$sim[[1]]

# St dev of chemicals
apply(sm, 2, sd)
apply(sm, 2, mean)
```  

```{r}
cormat3 <- cor(sim_over$sim[[1]])

melt(cormat3) %>% rename(Correlation = value) %>% 
  ggplot(aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent") +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        legend.position = "bottom") + 
        labs(title = "Overlapping patterns & independent scores")
```

## Save

```{r} 
# save(sim_over, file = "./Sims/sim_dim.RDA")

# for (i in 1:nrow(sim_over)) {
#   to_save = sim_over[i,]
#   save(to_save, file = paste0("./Sims/sim_dim/sim_dim", i, ".RDA"))
# }

# for (i in 1:nrow(sim_over)) {
#   to_save = as_tibble(sim_over$sim[[i]])
#   write_csv(to_save, path = paste0("./Sims/sim_dim/sim_dim", i, ".csv"))
# }

```

Need to repeat bc diff number of patterns requires diff functions!
```{r}
to_do = sim_over %>% dplyr::select(seed, participants, chemicals, patterns) %>% 
  mutate(row_num = 1:nrow(.)) %>% 
  filter(patterns != 4) %>% 
  pull(row_num)

save(to_do, file = "./R/to_do_dim.RDA")
```

