---
title: "Simulations â€” Results & Comparisons"
author: "Lizzy Gibson"
date: "10/19/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggsci)
library(GGally)
library(cowplot)

knitr::opts_chunk$set(
	echo = FALSE,
  warning = FALSE,
  message = FALSE,
	cache = TRUE,
	autodep=TRUE,
  fig.width = 8,
  fig.height = 6
)

knitr::dep_auto()

theme_set(theme_bw(base_size = 15) + 
            theme(legend.position = "bottom",
                  strip.background =element_rect(fill="white"),
                  axis.text.x = element_text(angle = 45, hjust = 1)))

ggsci <- pal_nejm()(8)

options(
  scipen = 999,
  ggplot2.discrete.colour = ggsci,
  ggplot2.discrete.fill = ggsci)
```

## Simulations

* 1000 individuals x 50 chemicals
* 4 underlying patterns
* all non-negative

### Raw x Raw

* scores = log normal distributions (mean = xxx, std = xxx)
* loadings = piecewise uniform (`on` = U(1-2); `off` = 0)
* no scaling factor
* scores x loadings
* distinct, overlapping, correlated
* Number of chemicals per pattern changes 

### Raw x Probability

* scores = log normal distributions (mean = xxx, std = xxx)
* loadings = probability vector (sum to 1)
* scaling factor = (1, 10, 100)
* scores x loadings x scaling factor
* distinct, overlapping

### Probability x Probability

* scores = probability vector (sum to 1)
* loadings = probability vector (sum to 1)
* scaling factor = (1, 10, 100, 1000)
* scores x loadings x scaling factor
* distinct, overlapping

## Raw x Raw

```{r, loaddgp, cache = TRUE, cache.lazy=FALSE}
load(file = here::here("./HPC/Rout/dgp.RDA"))
# dgp_data
```

```{r}
dgp_datasim <- 
  dgp_data %>% select(seed, data, sim) %>% 
  filter(seed == 1) %>% 
  mutate(sim = map(sim, as_tibble)) %>% 
  unnest(sim)
```

### Distributions

```{r plot6, fig.width = 8, fig.height = 2}
# Distinct
dgp_datasim %>% 
  filter(data == "Distinct") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(. ~ name, scales = "free", nrow = 1) +
  geom_histogram(bins = 100) + 
  labs(x = "Distinct Simulations",
       y = "Count")
```

```{r plot7, fig.width = 8, fig.height = 2}
# Overlapping
dgp_datasim %>% 
  filter(data == "Overlapping") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(. ~ name, scales = "free", nrow = 1) +
  geom_histogram(bins = 100) + 
  labs(x = "Overlapping Simulations",
       y = "Count")
```

#### Ranges

##### Distinct

* Means: (`r round(range(apply(as_tibble(dgp_data$sim[[1]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(dgp_data$sim[[1]]), 2, sd)), 4)`)

##### Overlapping

* Means: (`r round(range(apply(as_tibble(dgp_data$sim[[2]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(dgp_data$sim[[2]]), 2, sd)), 4)`)

### Correlations

```{r}
# Distinct
ggcorr(as_tibble(dgp_data$sim[[1]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Correlations for Distinct Simulations") +
  theme_minimal(base_size = 10)

```

```{r}
# Overlapping
ggcorr(as_tibble(dgp_data$sim[[2]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Correlations for Overlapping Simulations") +
  theme_minimal(base_size = 10)
```

## Raw x Prob

```{r, loadprob1, cache = TRUE, cache.lazy=FALSE}
load(file = here::here("./HPC/Rout/rawscores_normloadings.RDA"))
# norm_data
```

```{r}
norm_datasim <- 
  norm_data %>% select(seed, data, sim_factor, sim) %>% 
  filter(seed == 1) %>% 
  mutate(sim = map(sim, as_tibble)) %>% 
  unnest(sim)
```

### Distributions

```{r plot8, fig.width = 8, fig.height = 8}
# Distinct
norm_datasim %>% 
  filter(data == "Distinct") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(sim_factor ~ name, scales = "free", nrow = 3) +
  geom_histogram(bins = 100) + 
  labs(x = "Distinct Simulations",
       y = "Count")
```

```{r plot9, fig.width = 8, fig.height = 8}
# Overlapping
norm_datasim %>% 
  filter(data == "Overlapping") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(sim_factor ~ name, scales = "free", nrow = 3) +
  geom_histogram(bins = 100) + 
  labs(x = "Overlapping Simulations",
       y = "Count")
```

#### Ranges

##### Distinct

###### x1

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[1]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[1]]), 2, sd)), 4)`)

###### x10

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[2]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[2]]), 2, sd)), 4)`)

###### x100

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[3]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[3]]), 2, sd)), 4)`)

##### Overlapping

###### x1

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[4]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[4]]), 2, sd)), 4)`)

###### x10

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[5]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[5]]), 2, sd)), 4)`)

###### x100

* Means: (`r round(range(apply(as_tibble(norm_data$sim[[6]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(norm_data$sim[[6]]), 2, sd)), 4)`)

### Correlations

```{r}
# Distinct
norm_data_dist1 <- ggcorr(as_tibble(norm_data$sim[[1]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_dist10 <- ggcorr(as_tibble(norm_data$sim[[2]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x10") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_dist100 <- ggcorr(as_tibble(norm_data$sim[[3]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x100") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_legend_dist <- get_legend(
  norm_data_dist100 +
    theme(legend.position = "bottom")
)

norm_data_plot_dist <- plot_grid(norm_data_dist1, norm_data_dist10, norm_data_dist100, 
                                 align = 'vh',
          labels = c("A", "B", "C", "D"), hjust = -1, nrow = 2)

norm_data_title_dist <- ggdraw() +
  draw_label(
    "Correlations for Distinct Simulations",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) 

plot_grid(norm_data_title_dist, norm_data_plot_dist, norm_data_legend_dist, ncol = 1, rel_heights = c(.1, 1, .1))
```

```{r}
# Overlapping
norm_data_over1 <- ggcorr(as_tibble(norm_data$sim[[4]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_over10 <- ggcorr(as_tibble(norm_data$sim[[5]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x10") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_over100 <- ggcorr(as_tibble(norm_data$sim[[6]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x100") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

norm_data_legend_over <- get_legend(
  norm_data_over100 +
    theme(legend.position = "bottom")
)

norm_data_plot_over <- plot_grid(norm_data_over1, norm_data_over10, norm_data_over100,
                                 align = 'vh',
          labels = c("A", "B", "C", "D"), hjust = -1, nrow = 2)

norm_data_title_over <- ggdraw() +
  draw_label(
    "Correlations for Overlapping Simulations",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) 

plot_grid(norm_data_title_over, norm_data_plot_over, norm_data_legend_over, ncol = 1, rel_heights = c(.1, 1, .1))
```

## Prob x Prob

```{r, loadprob2, cache = TRUE, cache.lazy=FALSE}
load(file = here::here("./HPC/Rout/normscores_normloadings.RDA"))
# normall
```

```{r}
normallsim <- 
  normall %>% select(seed, data, sim_factor, sim) %>% 
  filter(seed == 1) %>% 
  mutate(sim = map(sim, as_tibble)) %>% 
  unnest(sim)
```

### Distributions

```{r plot10, fig.width = 8, fig.height = 8}
# Distinct
normallsim %>% 
  filter(data == "Distinct") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(sim_factor ~ name, scales = "free", nrow = 4) +
  geom_histogram(bins = 100) + 
  labs(x = "Distinct Simulations",
       y = "Count")
```

```{r plot11, fig.width = 8, fig.height = 8}
# Overlapping
normallsim %>% 
  filter(data == "Overlapping") %>% 
  select(-(V6:V50)) %>% 
  pivot_longer(V1:V5) %>% 
  ggplot(aes(x = value)) + 
  facet_wrap(sim_factor ~ name, scales = "free", nrow = 4) +
  geom_histogram(bins = 100) + 
  labs(x = "Overlapping Simulations",
       y = "Count")
```

### Ranges

#### Distinct

##### x1

* Means: (`r round(range(apply(as_tibble(normall$sim[[1]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[1]]), 2, sd)), 4)`)

##### x10

* Means: (`r round(range(apply(as_tibble(normall$sim[[2]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[2]]), 2, sd)), 4)`)

##### x100

* Means: (`r round(range(apply(as_tibble(normall$sim[[3]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[3]]), 2, sd)), 4)`)

##### x1000

* Means: (`r round(range(apply(as_tibble(normall$sim[[7]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[7]]), 2, sd)), 4)`)

#### Overlapping

##### x1

* Means: (`r round(range(apply(as_tibble(normall$sim[[4]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[4]]), 2, sd)), 4)`)

##### x10

* Means: (`r round(range(apply(as_tibble(normall$sim[[5]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[5]]), 2, sd)), 4)`)

##### x100

* Means: (`r round(range(apply(as_tibble(normall$sim[[6]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[6]]), 2, sd)), 4)`)

##### x1000

* Means: (`r round(range(apply(as_tibble(normall$sim[[8]]), 2, mean)), 4)`)
* Standard Deviations: (`r round(range(apply(as_tibble(normall$sim[[8]]), 2, sd)), 4)`)

### Correlations

```{r}
# Distinct
normall_dist1 <- ggcorr(as_tibble(normall$sim[[1]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_dist10 <- ggcorr(as_tibble(normall$sim[[2]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x10") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_dist100 <- ggcorr(as_tibble(normall$sim[[3]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x100") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_dist1000 <- ggcorr(as_tibble(normall$sim[[7]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1000") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_legend_dist <- get_legend(
  normall_dist100 +
    theme(legend.position = "bottom")
)

normall_plot_dist <- plot_grid(normall_dist1, normall_dist10, normall_dist100, normall_dist1000, align = 'vh',
          labels = c("A", "B", "C", "D"), hjust = -1, nrow = 2)

normall_title_dist <- ggdraw() +
  draw_label(
    "Correlations for Distinct Simulations",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) 

plot_grid(normall_title_dist, normall_plot_dist, normall_legend_dist, ncol = 1, rel_heights = c(.1, 1, .1))
```

```{r}
# Overlapping
normall_over1 <- ggcorr(as_tibble(normall$sim[[4]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_over10 <- ggcorr(as_tibble(normall$sim[[5]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x10") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_over100 <- ggcorr(as_tibble(normall$sim[[6]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x100") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_over1000 <- ggcorr(as_tibble(normall$sim[[8]]), limits = FALSE,
       hjust = 0.85, size = 2, layout.exp = 1) +
  labs(x = "Simulations x1000") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "none")

normall_legend_over <- get_legend(
  normall_over100 +
    theme(legend.position = "bottom")
)

normall_plot_over <- plot_grid(normall_over1, normall_over10, normall_over100, normall_over1000, align = 'vh',
          labels = c("A", "B", "C", "D"), hjust = -1, nrow = 2)

normall_title_over <- ggdraw() +
  draw_label(
    "Correlations for Overlapping Simulations",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) 

plot_grid(normall_title_over, normall_plot_over, normall_legend_over, ncol = 1, rel_heights = c(.1, 1, .1))
```

## Results

### Raw x Raw

#### Relative Prediction Error

```{r}
dgp_data_e <- dgp_data %>% 
  dplyr::select(seed, data, sim, chem, grep("pred", colnames(.))) %>% 
  dplyr::select(-pca_uncenter_pred) %>% 
  pivot_longer(pca_pred:bnmf_pred) %>% 
  mutate(l2_true = map2(chem, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
         l2_sim = map2(sim, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
    
         l1_true = map2(chem,value, function (x,y) sum(abs(x-y))/sum(abs(x))),
         l1_sim  = map2(sim, value, function (x,y) sum(abs(x-y))/sum(abs(x))),
    
         name = str_remove(name, "_pred")) %>% 
  dplyr::select(seed, data, name, l2_true, l2_sim, l1_true, l1_sim) %>% 
  unnest(c(l2_sim, l2_true, l1_true, l1_sim))

dgp_data_e %>%
  ggplot(aes(x = name, y = l1_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(. ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L1 Error (vs pre-noise truth)")

dgp_data_e %>%
  ggplot(aes(x = name, y = l2_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(. ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L2 Error (vs pre-noise truth)",
       x = "Method")

```

#### Symmetric Subspace Distance

```{r}
dgp_data_s <- dgp_data %>% dplyr::select(seed, data, grep("_ssdist", colnames(.))) %>% 
  dplyr::select(-grep("uncenter", colnames(.))) %>% 
  unnest(cols = grep("_ssdist", colnames(.))) %>% 
  pivot_longer(grep("_ssdist", colnames(.)),
               names_to = "type",
               values_to = "value") %>%
  mutate(model = str_sub(type, 1, 6),
         model = ifelse(str_detect(model, 'pca'), 'PCA', model),
         model = ifelse(str_detect(model, 'l2'), 'L2 NMF', model),
         model = ifelse(str_detect(model, 'fa'), 'FA', model),
         model = ifelse(str_detect(model, '_p_'), 'Poisson NMF', model),
         model = ifelse(str_detect(model, 'bnmf'), 'BNMF', model),
         type = ifelse(str_detect(type, 'scores'), 'Scores', "Loadings"))

dgp_data_s %>% 
  ggplot(aes(x = model, y = value, color = model)) +
  geom_boxplot() +
  facet_grid(. ~ type + data) + 
  geom_hline(yintercept = 0.5, color = "pink", linetype = "dashed", size = 0.5) +
  theme(legend.position = "none") + 
  labs(y = "Symmetric Subspace Distance",
       x = "Method")

```

#### Patterns Identified

```{r}
dgp_data %>%
  dplyr::select(seed, data, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Distinct") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  dplyr::select(name, `1`,`2`,`3`,`4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Distinct Simulations: Patterns Identified")

dgp_data %>%
  dplyr::select(seed, data, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Overlapping") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  dplyr::select(name, `1`, `2`, `3`, `4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Overlapping Simulations: Patterns Identified")
```

### Raw x Prob

#### Relative Prediction Error

```{r}
norm_data_e <- norm_data %>% 
  dplyr::select(seed, data, sim_factor, sim, chem, grep("pred", colnames(.))) %>% 
  dplyr::select(-pca_uncenter_pred) %>% 
  pivot_longer(pca_pred:bnmf_pred) %>% 
  mutate(l2_true = map2(chem, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
         l2_sim = map2(sim, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
    
         l1_true = map2(chem,value, function (x,y) sum(abs(x-y))/sum(abs(x))),
         l1_sim  = map2(sim, value, function (x,y) sum(abs(x-y))/sum(abs(x))),
    
         name = str_remove(name, "_pred")) %>% 
  dplyr::select(seed, data, sim_factor, name, l2_true, l2_sim, l1_true, l1_sim) %>% 
  unnest(c(l2_sim, l2_true, l1_true, l1_sim))

norm_data_e %>%
  ggplot(aes(x = name, y = l1_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(sim_factor ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L1 Error (vs pre-noise truth)")

norm_data_e %>%
  ggplot(aes(x = name, y = l2_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(sim_factor ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L2 Error (vs pre-noise truth)",
       x = "Method")

```

#### Symmetric Subspace Distance

```{r}
norm_data_s <- norm_data %>% dplyr::select(seed, data, sim_factor, grep("_ssdist", colnames(.))) %>% 
  dplyr::select(-grep("uncenter", colnames(.))) %>% 
  unnest(cols = grep("_ssdist", colnames(.))) %>% 
  pivot_longer(grep("_ssdist", colnames(.)),
               names_to = "type",
               values_to = "value") %>%
  mutate(model = str_sub(type, 1, 6),
         model = ifelse(str_detect(model, 'pca'), 'PCA', model),
         model = ifelse(str_detect(model, 'l2'), 'L2 NMF', model),
         model = ifelse(str_detect(model, 'fa'), 'FA', model),
         model = ifelse(str_detect(model, '_p_'), 'Poisson NMF', model),
         model = ifelse(str_detect(model, 'bnmf'), 'BNMF', model),
         type = ifelse(str_detect(type, 'scores'), 'Scores', "Loadings"))

norm_data_s %>% 
  ggplot(aes(x = model, y = value, color = model)) +
  geom_boxplot() +
  facet_grid(sim_factor ~ type + data) + 
  geom_hline(yintercept = 0.5, color = "pink", linetype = "dashed", size = 0.5) +
  theme(legend.position = "none") + 
  labs(y = "Symmetric Subspace Distance",
       x = "Method")

```

#### Patterns Identified

```{r}
norm_data %>%
  dplyr::select(seed, data, sim_factor, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data, sim_factor) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Distinct") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  arrange(sim_factor) %>% 
  dplyr::select(sim_factor, name, `1`,`3`,`4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Distinct Simulations: Patterns Identified")

norm_data %>%
  dplyr::select(seed, data, sim_factor, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data, sim_factor) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Overlapping") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  arrange(sim_factor) %>% 
  dplyr::select(sim_factor, name, `1`, `2`, `3`, `4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Overlapping Simulations: Patterns Identified")
```

### Prob x Prob

#### Relative Prediction Error

```{r}
normall_e <- normall %>% 
  dplyr::select(seed, data, sim_factor, sim, chem, grep("pred", colnames(.))) %>% 
  dplyr::select(-pca_uncenter_pred) %>% 
  pivot_longer(pca_pred:bnmf_pred) %>% 
  mutate(l2_true = map2(chem, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
         l2_sim = map2(sim, value, function (x,y) norm(x-y, "F")/norm(x, "F")),
    
         l1_true = map2(chem,value, function (x,y) sum(abs(x-y))/sum(abs(x))),
         l1_sim  = map2(sim, value, function (x,y) sum(abs(x-y))/sum(abs(x))),
    
         name = str_remove(name, "_pred")) %>% 
  dplyr::select(seed, data, sim_factor, name, l2_true, l2_sim, l1_true, l1_sim) %>% 
  unnest(c(l2_sim, l2_true, l1_true, l1_sim))

normall_e %>%
  ggplot(aes(x = name, y = l1_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(sim_factor ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L1 Error (vs pre-noise truth)")

normall_e %>%
  ggplot(aes(x = name, y = l2_true, color = name, fill = name)) +
  geom_boxplot(alpha = 0.5) +
  facet_grid(sim_factor ~ data) + 
  geom_vline(xintercept = 0, color = "pink", linetype = "dashed", size = 0.5) +
  scale_y_log10() +
  theme(legend.position = "none") + 
  labs(y = "Relative Predictive Error",
       title = "L2 Error (vs pre-noise truth)",
       x = "Method")

```

#### Symmetric Subspace Distance

```{r}
normall_s <- normall %>% dplyr::select(seed, data, sim_factor, grep("_ssdist", colnames(.))) %>% 
  dplyr::select(-grep("uncenter", colnames(.))) %>% 
  unnest(cols = grep("_ssdist", colnames(.))) %>% 
  pivot_longer(grep("_ssdist", colnames(.)),
               names_to = "type",
               values_to = "value") %>%
  mutate(model = str_sub(type, 1, 6),
         model = ifelse(str_detect(model, 'pca'), 'PCA', model),
         model = ifelse(str_detect(model, 'l2'), 'L2 NMF', model),
         model = ifelse(str_detect(model, 'fa'), 'FA', model),
         model = ifelse(str_detect(model, '_p_'), 'Poisson NMF', model),
         model = ifelse(str_detect(model, 'bnmf'), 'BNMF', model),
         type = ifelse(str_detect(type, 'scores'), 'Scores', "Loadings"))

normall_s %>% 
  ggplot(aes(x = model, y = value, color = model)) +
  geom_boxplot() +
  facet_grid(sim_factor ~ type + data) + 
  geom_hline(yintercept = 0.5, color = "pink", linetype = "dashed", size = 0.5) +
  theme(legend.position = "none") + 
  labs(y = "Symmetric Subspace Distance",
       x = "Method")

```

#### Patterns Identified

```{r}
normall %>%
  dplyr::select(seed, data, sim_factor, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data, sim_factor) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Distinct") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  arrange(sim_factor) %>% 
  dplyr::select(sim_factor, name, `1`,`3`,`4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Distinct Simulations: Patterns Identified")

normall %>%
  dplyr::select(seed, data, sim_factor, fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank) %>%
  unnest(c(fa_rank, pca_rank, nmf_l2_rank, nmf_p_rank, bnmf_rank)) %>%
  pivot_longer(cols = fa_rank:bnmf_rank) %>%
  mutate(value = ifelse(value > 5, "> 5", value)) %>% 
  group_by(name, value, data, sim_factor) %>%
  summarise(n = n()) %>% 
  ungroup() %>% 
  filter(data == "Overlapping") %>% 
  dplyr::select(-data) %>% 
  pivot_wider(names_from = value,
              values_from = n) %>% 
  mutate_if(is.integer, replace_na, 0) %>% 
  arrange(sim_factor) %>% 
  dplyr::select(sim_factor, name, `1`, `2`, `3`, `4`, `5`, `> 5`) %>% 
  knitr::kable(caption = "Overlapping Simulations: Patterns Identified")
```



