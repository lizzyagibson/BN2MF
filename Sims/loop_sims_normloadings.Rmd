---
title: "Loop Simulations"
author: "Lizzy Gibson"
date: "3/5/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)
library(reshape2) # melt
library(gridExtra) # gridarrange
library(bindata) # multivariate binomial dist
library(NMF) # rmatrix
library(MASS) # mvrnorm
library(tidyverse)
library(R.matlab)
library(MCMCpack) # for dirichlet
```

## 1: Distinct Patterns

### Simulate Patterns

* Generate 4 non-negative vectors of length 50
* Pattern matrix is 4*50, patterns by chemicals.
* Draw each pattern from dirichlet (rows sum to 1)

```{r}
create_patterns_dist <- function (seed) {
  set.seed(seed)
  patterns_dist <- rbind(rdirichlet(1, c(rep(10, 12), rep(0.1, 38))),
                         rdirichlet(1, c(rep(0.1, 12), rep(10, 12), rep(0.1, 26))),
                         rdirichlet(1, c(rep(0.1, 24), rep(10, 13), rep(0.1, 13))),
                         rdirichlet(1, c(rep(0.1, 37), rep(10, 13))))
  patterns_dist
}

patterns_dist_iter <- tibble(seed = 1:100) %>% 
 mutate(true_patterns = map(seed, create_patterns_dist))
```

```{r}
patterns_dist_iter[1,2][[1]][[1]] %>% as_tibble() %>% 
  mutate(Pattern = 1:4) %>% 
  dplyr::select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col() +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_blank(),
        strip.background = element_blank()) +
  labs(title = "Distinct Patterns")
```

### Simulate Scores

* Generate non-negative scores
* 1,000 individuals with scores on each of 4 patterns
* Individual distributions are independent
* Patterns (columns) are standardized to stdev = 1
   * Not mean-centered

```{r}
create_scores_dist <- function (seed) {
  scores_dist <- matrix(nrow = 1000, ncol = 4)
  set.seed(seed)
  scores_dist <- exp(mvrnorm(n = 1000, mu = rep(0, 4), 
                          Sigma = diag(rep(1, 4)))) # independent log normal dist
  scores_dist <- apply(scores_dist, 2, function (x) x/sd(x)) # divide columns by standard dev 
  scores_dist
  }

scores_dist_iter <- patterns_dist_iter %>% 
 mutate(true_scores = map(seed, create_scores_dist))

# st dev of scores
apply(scores_dist_iter[1,3][[1]][[1]], 2, sd)
```

### Simulate Chemical Exposures

* Matrix multiple scores and pattern loadings

```{r}
sim_dist <- scores_dist_iter %>% 
  mutate(chem_1 = map2(true_scores, true_patterns, `%*%`),
         chem_10 = map(chem_1, function(x) x*10),
         chem_100 = map(chem_1, function(x) x*100))

# St dev of chemicals
apply(sim_dist[1,4][[1]][[1]], 2, mean)
apply(sim_dist[1,5][[1]][[1]], 2, mean)
apply(sim_dist[1,6][[1]][[1]], 2, mean)
```

### Simulate Noise

* Add noise

```{r}
# noise = 1000x50
add_noise <- function (seed, chemx) {
  noise <- list(mean = 0, sd = apply(chemx, 2, sd)/2)
  set.seed(seed)
  chem_dist <- pmax(chemx + mvrnorm(n = 1000, mu = rep(0, 50), 
                                             Sigma = diag(noise$sd)), 0)	
  chem_dist
}

sim_dist <- sim_dist %>% 
 mutate(sim_1 = map2(seed, chem_1, add_noise),
        sim_10 = map2(seed, chem_10, add_noise),
        sim_100 = map2(seed, chem_100, add_noise))

# St dev of chemicals
apply(sim_dist[1,7][[1]][[1]], 2, sd)
apply(sim_dist[1,8][[1]][[1]], 2, sd)
apply(sim_dist[1,9][[1]][[1]], 2, sd)
```

```{r}
sim7 <- cor(sim_dist[1,8][[1]][[1]])

melt(sim7) %>% rename(Correlation = value) %>% 
ggplot(aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent", limits = c(-1, 1)) +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        strip.placement = "outside", legend.position = "bottom") + ggtitle("Correlation w/ Distinct Underlying Patterns")
```

## 2: Overlapping Patterns

### Simulate Patterns

```{r}
## Construct a matrix for 4 TRUE exposure patterns
create_patterns_over <- function (seed) {
  set.seed(seed)
  patterns_cor <- rbind( rdirichlet(1, c(rep(10,  12),  rep(5,  12),   rep(0.1, 26))),
                         rdirichlet(1, c(rep(0.1, 12),  rep(10,  12),  rep(5,   13), rep(0.1, 13))),
                         rdirichlet(1, c(rep(0.1, 12),  rep(5,   12),  rep(10,  13), rep(0.1, 13))),
                         rdirichlet(1, c(rep(5,   12),  rep(0.1, 25),                rep(10,  13))))
  patterns_cor
}

patterns_over_iter <- tibble(seed = 1:100) %>% 
 mutate(true_patterns = map(seed, create_patterns_over))
```

```{r}
patterns_over_iter[1,2][[1]][[1]] %>% as_tibble() %>% 
  mutate(Pattern = 1:4) %>% dplyr::select(Pattern, everything()) %>% 
  gather(key = Chemicals, value = Loadings, -Pattern) %>% 
  mutate(Chemicals = fct_inorder(Chemicals)) %>%
  ggplot(aes(x = Chemicals, y = Loadings)) + geom_col() +
  facet_wrap(.~Pattern) + theme_bw() +
  theme(axis.text.x = element_text(angle = 45),
        strip.background = element_blank()) +
  labs(title = "Overlapping Patterns")
```

### Simulate Scores

Use distinct scores.

### Simulate Chemical Exposures

Multiple scores and vectors, and add to get the mixture.

```{r}
sim_over <- scores_dist_iter %>% 
  select(seed, true_scores) %>% 
  full_join(., patterns_over_iter) %>% 
  mutate(chem_1 = map2(true_scores, true_patterns, `%*%`),
         chem_10 = map(chem_1, function(x) x*10),
         chem_100 = map(chem_1, function(x) x*100))

chem <- sim_over[1,4][[1]][[1]]
chem10 <- sim_over[1,5][[1]][[1]]
chem100 <- sim_over[1,6][[1]][[1]]

# St dev of chemicals
apply(chem100, 2, sd)
summary(chem10)
```

### Simulate Noise

```{r}
sim_over <- sim_over %>% 
 mutate(sim_1 = map2(seed, chem_1, add_noise),
        sim_10 = map2(seed, chem_10, add_noise),
        sim_100 = map2(seed, chem_100, add_noise))

# St dev of chemicals
apply(sim_over[1,7][[1]][[1]], 2, sd)

sm <- sim_over[1,7][[1]][[1]]
sm10 <- sim_over[1,8][[1]][[1]]
sm100 <- sim_over[1,9][[1]][[1]]

# St dev of chemicals
apply(sm, 2, sd)
apply(sm10, 2, sd)
apply(sm100, 2, sd)
```  

```{r}
cormat3 <- cor(sim_over[100,9][[1]][[1]])

melt(cormat3) %>% rename(Correlation = value) %>% 
  ggplot(aes(x = Var1, y = Var2)) +
  geom_tile(aes(fill = Correlation), colour = "white") +
  scale_fill_gradient2(low = "#00BFC4", mid = "white", high = "#F8766D",
                       midpoint = 0,
                       na.value = "transparent") +
  theme_grey() + labs(x = "", y = "") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(axis.text = element_blank(),
        panel.spacing = unit(0, "lines"),
        strip.background = element_blank(),
        legend.position = "bottom") + 
        labs(title = "Overlapping patterns & independent scores")
```

## Save

```{r} 
sim_norm <- rbind(sim_dist %>% mutate(data = "Distinct"),
      sim_over %>% mutate(data = "Overlapping")) %>% 
      mutate(sim_type = "L1 Norm") %>% 
      pivot_longer(c(chem_1:sim_100),
                   names_to = c("chem_sim", "sim_factor"),
                   names_sep = "_",
                   values_to = "sim_chem_matrix") %>% 
      pivot_wider(names_from = "chem_sim",
                  values_from = "sim_chem_matrix")

sim_norm
# save(sim_norm, file = "./Sims/sim_norm.RDA")
```

### Test

```{r}
# No noise
## Distinct Patterns
dist <- sim_norm[10,7][[1]][[1]]     # 1
dist_10 <- sim_norm[11,7][[1]][[1]]  # 10
dist_100 <- sim_norm[12,7][[1]][[1]] # 100

NPBayesNMF(dist)     # Only 1 pattern found
NPBayesNMF(dist_10)  # 4 patterns found
NPBayesNMF(dist_100) # 4 patterns found

## Overlapping Patterns
over <- sim_norm[310,7][[1]][[1]]     # 1
over_10 <- sim_norm[311,7][[1]][[1]]  # 10
over_100 <- sim_norm[312,7][[1]][[1]] # 100

NPBayesNMF(over)     # Only 1 pattern found
NPBayesNMF(over_10)  # 3 patterns found
NPBayesNMF(over_100) # 4 patterns found

# Yes noise
## Distinct Patterns
dist <- sim_norm[10,8][[1]][[1]]     # 1
dist_10 <- sim_norm[11,8][[1]][[1]]  # 10
dist_100 <- sim_norm[12,8][[1]][[1]] # 100

NPBayesNMF(dist)     # Only 1 pattern found
NPBayesNMF(dist_10)  # 4 patterns found
NPBayesNMF(dist_100) # 4 patterns found

## Overlapping Patterns
over <- sim_norm[310,8][[1]][[1]]     # 1
over_10 <- sim_norm[311,8][[1]][[1]]  # 10
over_100 <- sim_norm[312,8][[1]][[1]] # 100

NPBayesNMF(over)     # Only 1 pattern found
NPBayesNMF(over_10)  # 4 patterns found
NPBayesNMF(over_100) # 3 patterns

```

