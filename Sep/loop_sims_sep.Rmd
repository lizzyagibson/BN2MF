---
title: "Loop Simulations: Separable"
author: "Lizzy Gibson"
date: "2/17/2021"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)

library(tidyverse)
library(GGally)
library(LearnBayes)
library(openssl)
```

## 1: Separate Patterns

### Simulate Patterns

```{r}
#vec = as.integer(rand_num(100) * ((2^31)-1))
vec = c(700684056, 1867904293, 65850223, 1772634887, 1040993128,141231838, 2005759315, 1896822533, 1757155251, 1220527822, 1885771483,870084240, 2012640598, 2003633293,251030614,945490134  ,595315152  ,155324059, 27795916, 51959299, 1667198387,976118250, 1753042688,388612961, 1913079091,1975206587,115229131,471179375,114133192,263721098, 1740423388, 1633822372, 1870807198, 1340426030, 1531029051,1974454967,185921701,233046359, 1012347579, 2023377992, 840117793,386558621, 1179178110, 1654966055, 1906057197,660645740,678123473, 1113633474,326491996,466505473, 1972085792,323029779, 1029672915, 2087424299, 1485111652,1603321280, 2030739537,278602890,734565781, 1420598166, 25736392, 1777453769,685473986, 1591164280,917006407,1053830487  ,343738424  ,756468029, 1041634570,483181508, 457544183,776436290, 1072907123, 1874737454,982500331,365185873  ,594289973 ,1114286433, 1468409404, 2127296756, 1144795881, 13544360, 90272022,313399869,884323089,120722603  ,897654480 ,1486312666, 1767255887,702462128, 1535757335, 1532116316, 1712351845,181291115, 1320123132,1287014693,653189808,1912056679,750369475,997500018)
rand_vec = rep(vec, 3)

## Construct a matrix for 4 TRUE exposure patterns
create_patterns <- function (seed, reps) {
  set.seed(seed)
  pat1=c(0,0,5,10)
  pat2=c(0,5,10,0)
  pat3=c(5,10,0,0)
  pat4=c(10,0,0,5)
  
  start = c()
  for (i in 1:reps) {
    start = cbind(start,diag(1,4))
  }
  
  patterns = cbind(start, t(rdirichlet(13-reps, pat1)), t(rdirichlet(13-reps, pat2)),
                   t(rdirichlet(12-reps, pat3)), t(rdirichlet(12-reps, pat4)))
  return(patterns)
}

reps = c(rep(1, 100), rep(2, 100), rep(3, 100))

patterns_iter <- tibble(seed = rand_vec, reps, data = "Separate") %>% 
 mutate(true_patterns = map2(seed, reps, create_patterns))
```

### Simulate Scores
   
```{r}
create_scores <- function (seed) {
  set.seed(seed)
  scores <- matrix(exp(rnorm(1000*4)), ncol = 4)

  return(scores)
}

scores_iter <- patterns_iter %>% 
 mutate(true_scores = map(seed, create_scores))
```

### Simulate Chemical Exposures

* Matrix multiple scores and pattern loadings

```{r}
sim_iter <- scores_iter %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))
```

### Simulate Noise

* Add noise
* Noise distribution Normal(0, 1)
    
```{r}
add_noise <- function (seed, chemx) {
  n = nrow(chemx)
  p = ncol(chemx)
  noise <- matrix(rnorm(n*p, mean = 0, sd = 1), nrow = n, ncol = p)
  sim = pmax(chemx + noise, 0)
  return(sim)
}

sims <- sim_iter %>% 
 mutate(sim = map2(seed, chem, add_noise))
```  

```{r}
dist <- sims$sim[[1]]
ggcorr(dist)
```

## Save

```{r} 
sims
  
# for (i in 1:nrow(sims)) {
#   write_csv(as_tibble(sims$sim[[i]]),           paste0("./Sims/Sep/sim_sep_", i, ".csv"))
#   write_csv(as_tibble(sims$chem[[i]]),          paste0("./Sims/Sep/chem_sep_", i, ".csv"))
#   write_csv(as_tibble(sims$true_patterns[[i]]), paste0("./Sims/Sep/patterns_sep_", i, ".csv"))
#   write_csv(as_tibble(sims$true_scores[[i]]),   paste0("./Sims/Sep/scores_sep_", i, ".csv"))
# }

# save(sims, file = "./Sims/sim_sep.RDA")
```

