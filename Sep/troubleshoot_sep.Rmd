---
title: "Troubleshoot"
author: "Lizzy Gibson"
date: "3/5/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
options(scipen = 999)

library(MASS)
library(tidyverse)
library(GGally)
library(openssl)
```

## 1: Distinct Patterns

### Simulate Patterns

* Generate 4 non-negative vectors of length 50
* Pattern matrix is 4*50, patterns by chemicals
* Draw each pattern: number 1-2 if pattern is ON, basically 0 otherwise

```{r}
rand_vec = c(700684056, 1867904293, 65850223, 1772634887, 1040993128,141231838, 2005759315, 1896822533, 1757155251, 1220527822, 1885771483,870084240, 2012640598, 2003633293,251030614,945490134  ,595315152  ,155324059, 27795916, 51959299, 1667198387,976118250, 1753042688,388612961, 1913079091,1975206587,115229131,471179375,114133192,263721098, 1740423388, 1633822372, 1870807198, 1340426030, 1531029051,1974454967,185921701,233046359, 1012347579, 2023377992, 840117793,386558621, 1179178110, 1654966055, 1906057197,660645740,678123473, 1113633474,326491996,466505473, 1972085792,323029779, 1029672915, 2087424299, 1485111652,1603321280, 2030739537,278602890,734565781, 1420598166, 25736392, 1777453769,685473986, 1591164280,917006407,1053830487  ,343738424  ,756468029, 1041634570,483181508, 457544183,776436290, 1072907123, 1874737454,982500331,365185873  ,594289973 ,1114286433, 1468409404, 2127296756, 1144795881, 13544360, 90272022,313399869,884323089,120722603  ,897654480 ,1486312666, 1767255887,702462128, 1535757335, 1532116316, 1712351845,181291115, 1320123132,1287014693,653189808,1912056679,750369475,997500018)
#rand_vec = as.integer(rand_num(100) * ((2^31)-1))
# Above comes from rand_num() but needs to be saved!
## Construct a matrix for 4 TRUE exposure patterns
## replace runif between 0--0.2 with rep 0
create_patterns_old <- function (seed) {
  set.seed(seed)
  patterns_dist <- 
    rbind(c(runif(12, 1, 2),   rep(0, 38)),
          c(rep(0, 12),        runif(12, 1, 2),   rep(0, 26)),
          c(rep(0, 24),                           runif(13, 1, 2),  rep(0, 13)),
          c(rep(0, 37), runif(13, 1, 2)))
  patterns_dist
}

create_patterns_new <- function (seed) {
  set.seed(seed)
  patterns_dist <- 
    rbind(c(rep(1,12), rep(0,38)),
          c(rep(0,12), rep(1,12), rep(0,26)),
          c(rep(0,24), rep(1,13), rep(0,13)),
          c(rep(0,37), rep(1,13)))
  patterns_dist
}

create_patterns_2 <- function (seed) {
  set.seed(seed)
  patterns_dist <- 
    rbind(c(rep(2,12), rep(0,38)),
          c(rep(0,12), rep(2,12), rep(0,26)),
          c(rep(0,24), rep(2,13), rep(0,13)),
          c(rep(0,37), rep(2,13)))
  patterns_dist
}

patterns_old <- tibble(seed = 1:10) %>% 
 mutate(true_patterns = map(seed, create_patterns_old))

patterns_rand <- tibble(seed = rand_vec[1:10]) %>% 
 mutate(true_patterns = map(seed, create_patterns_old))

patterns_rand_new <- tibble(seed = rand_vec[1:10]) %>% 
 mutate(true_patterns = map(seed, create_patterns_new))

patterns_2 <- tibble(seed = 1:10) %>% 
 mutate(true_patterns = map(seed, create_patterns_2))
```

### Simulate Scores
   
```{r}
create_scores_old <- function (seed) {
  scores_dist <- matrix(nrow = 1000, ncol = 4)
  set.seed(seed)
  scores_dist <- exp(mvrnorm(n = 1000, mu = rep(0, 4),
                          Sigma = diag(rep(1, 4))))
  scores_dist
}

create_scores_new <- function (seed) {
  set.seed(seed)
  scores <- matrix(exp(rnorm(1000*4)), ncol = 4)

  return(as.matrix(scores))
}

# all old
all_old <- patterns_old %>% 
 mutate(true_scores = map(seed, create_scores_old),
        type = "old patterns, old scores, old seeds")

# old scores, old patterns, rand seeds
scores_old_rand <- patterns_rand %>% 
 mutate(true_scores = map(seed, create_scores_old),
        type = "old patterns, old scores, rand seeds")

# old scores, new patterns, rand seed
scores_old <- patterns_rand_new %>% 
 mutate(true_scores = map(seed, create_scores_old),
        type = "new patterns, old scores, rand seeds")

# new scores, old patterns, rand seed
scores_new <- patterns_rand %>% 
 mutate(true_scores = map(seed, create_scores_new),
        type = "old patterns, new scores, rand seeds")

scores_2 <- patterns_2 %>% 
 mutate(true_scores = map(seed, create_scores_new),
        type = "2 patterns, new scores, old seeds")
```

```{r}
patterns_scores = bind_rows(all_old, scores_old, scores_old_rand, scores_new, scores_2)
```

### Simulate Chemical Exposures

* Matrix multiple scores and pattern loadings

```{r}
sim_dist <- patterns_scores %>% 
  mutate(chem = map2(true_scores, true_patterns, `%*%`))
```

### Simulate Noise
    
```{r}
# add_noise <- function (seed, chemx) {
#   n = nrow(chemx)
#   p = ncol(chemx)
#   noise <- matrix(NA, nrow = n, ncol = p)
# 
#   for (i in 1:p) {
#     noise[,i] <- (rnorm(n, mean = 0, sd = 1))
#   }
#   sim = pmax(chemx + noise, 0)
#   sim
# }
add_noise <- function (seed, chemx) {
  n = nrow(chemx)
  p = ncol(chemx)
  noise <- matrix(rnorm(n*p, mean = 0, sd = 0.5), nrow = n, ncol = p)
  sim = pmax(chemx + noise, 0)
  return(sim)
}

sim_dist <- sim_dist %>% 
 mutate(sim = map2(seed, chem, add_noise))
```  

```{r}
dist <- sim_dist$sim[[41]]
ggcorr(dist)
cor(dist)[1:5,1:5]

# all_old, scores_old, scores_old_rand, scores_new
sort(apply(sim_dist$chem[[1]], 2, sd))
sort(apply(sim_dist$chem[[11]], 2, sd))
sort(apply(sim_dist$chem[[21]], 2, sd))
sort(apply(sim_dist$chem[[31]], 2, sd))
sort(apply(sim_dist$chem[[41]], 2, sd))

# d = wh + n
```

## Save

```{r} 
sim_dist

# for (i in 1:nrow(sim_dist)) {
#   write_csv(as_tibble(sim_dist$sim[[i]]),           paste0("./Sims/troubleshoot/sim_q_", i, "_0.5.csv"))
#   write_csv(as_tibble(sim_dist$chem[[i]]),          paste0("./Sims/troubleshoot/chem_q_", i, "_0.5.csv"))
#   write_csv(as_tibble(sim_dist$true_patterns[[i]]), paste0("./Sims/troubleshoot/patterns_q_", i, "_0.5.csv"))
#   write_csv(as_tibble(sim_dist$true_scores[[i]]),   paste0("./Sims/troubleshoot/scores_q_", i, "_0.5.csv"))
# }

# save(sim_dist, file = "./Sims/sim_trouble_0.5.RDA")
```
